
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Not a Pkg Tool - Windows/Intune packaging with PSADT">
      
      
        <meta name="author" content="Roger Cibrian">
      
      
        <link rel="canonical" href="https://rogercibrian.github.io/notapkgtool/api/discovery/">
      
      
        <link rel="prev" href="../config/">
      
      
        <link rel="next" href="../io/">
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>discovery - NAPT Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="deep-orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#discovery" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="NAPT Documentation" class="md-header__button md-logo" aria-label="NAPT Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            NAPT Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              discovery
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="deep-orange"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="deep-orange"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/RogerCibrian/notapkgtool" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    RogerCibrian/notapkgtool
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../quick-start/" class="md-tabs__link">
        
  
  
    
  
  Quick Start

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../user-guide/" class="md-tabs__link">
        
  
  
    
  
  User Guide

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../cli/" class="md-tabs__link">
          
  
  
  API Reference

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../changelog/" class="md-tabs__link">
        
  
  
    
  
  Changelog

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../roadmap/" class="md-tabs__link">
        
  
  
    
  
  Roadmap

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../contributing/" class="md-tabs__link">
        
  
  
    
  
  Contributing

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="NAPT Documentation" class="md-nav__button md-logo" aria-label="NAPT Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    NAPT Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/RogerCibrian/notapkgtool" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    RogerCibrian/notapkgtool
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quick-start/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quick Start
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../user-guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    User Guide
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    API Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    cli
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../core/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    core
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../validation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    validation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4_4" id="__nav_4_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Modules
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Modules
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../build/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    build
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    config
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    discovery
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    discovery
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#notapkgtool.discovery.base" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;base
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" base">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#notapkgtool.discovery.base.DiscoveryStrategy" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;DiscoveryStrategy
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" DiscoveryStrategy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#notapkgtool.discovery.base.DiscoveryStrategy.discover_version" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;discover_version
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#notapkgtool.discovery.base.DiscoveryStrategy.validate_config" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;validate_config
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#notapkgtool.discovery.base.register_strategy" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;register_strategy
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#notapkgtool.discovery.base.get_strategy" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_strategy
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#notapkgtool.discovery.url_download" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;url_download
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" url_download">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#notapkgtool.discovery.url_download.UrlDownloadStrategy" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;UrlDownloadStrategy
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" UrlDownloadStrategy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#notapkgtool.discovery.url_download.UrlDownloadStrategy.discover_version" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;discover_version
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#notapkgtool.discovery.url_download.UrlDownloadStrategy.validate_config" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;validate_config
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#notapkgtool.discovery.web_scrape" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;web_scrape
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" web_scrape">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#notapkgtool.discovery.web_scrape.WebScrapeStrategy" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;WebScrapeStrategy
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" WebScrapeStrategy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#notapkgtool.discovery.web_scrape.WebScrapeStrategy.get_version_info" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_version_info
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#notapkgtool.discovery.web_scrape.WebScrapeStrategy.validate_config" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;validate_config
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#notapkgtool.discovery.api_github" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;api_github
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" api_github">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#notapkgtool.discovery.api_github.ApiGithubStrategy" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;ApiGithubStrategy
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" ApiGithubStrategy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#notapkgtool.discovery.api_github.ApiGithubStrategy.get_version_info" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_version_info
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#notapkgtool.discovery.api_github.ApiGithubStrategy.validate_config" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;validate_config
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#notapkgtool.discovery.api_json" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;api_json
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" api_json">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#notapkgtool.discovery.api_json.ApiJsonStrategy" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;ApiJsonStrategy
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" ApiJsonStrategy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#notapkgtool.discovery.api_json.ApiJsonStrategy.get_version_info" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_version_info
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#notapkgtool.discovery.api_json.ApiJsonStrategy.validate_config" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;validate_config
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../io/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    io
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../policy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    policy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../psadt/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    psadt
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../state/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    state
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../versioning/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    versioning
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../changelog/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Changelog
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../roadmap/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Roadmap
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Contributing
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#notapkgtool.discovery.base" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;base
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" base">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#notapkgtool.discovery.base.DiscoveryStrategy" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;DiscoveryStrategy
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" DiscoveryStrategy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#notapkgtool.discovery.base.DiscoveryStrategy.discover_version" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;discover_version
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#notapkgtool.discovery.base.DiscoveryStrategy.validate_config" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;validate_config
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#notapkgtool.discovery.base.register_strategy" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;register_strategy
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#notapkgtool.discovery.base.get_strategy" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_strategy
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#notapkgtool.discovery.url_download" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;url_download
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" url_download">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#notapkgtool.discovery.url_download.UrlDownloadStrategy" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;UrlDownloadStrategy
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" UrlDownloadStrategy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#notapkgtool.discovery.url_download.UrlDownloadStrategy.discover_version" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;discover_version
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#notapkgtool.discovery.url_download.UrlDownloadStrategy.validate_config" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;validate_config
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#notapkgtool.discovery.web_scrape" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;web_scrape
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" web_scrape">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#notapkgtool.discovery.web_scrape.WebScrapeStrategy" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;WebScrapeStrategy
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" WebScrapeStrategy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#notapkgtool.discovery.web_scrape.WebScrapeStrategy.get_version_info" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_version_info
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#notapkgtool.discovery.web_scrape.WebScrapeStrategy.validate_config" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;validate_config
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#notapkgtool.discovery.api_github" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;api_github
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" api_github">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#notapkgtool.discovery.api_github.ApiGithubStrategy" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;ApiGithubStrategy
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" ApiGithubStrategy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#notapkgtool.discovery.api_github.ApiGithubStrategy.get_version_info" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_version_info
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#notapkgtool.discovery.api_github.ApiGithubStrategy.validate_config" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;validate_config
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#notapkgtool.discovery.api_json" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;api_json
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" api_json">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#notapkgtool.discovery.api_json.ApiJsonStrategy" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;ApiJsonStrategy
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" ApiJsonStrategy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#notapkgtool.discovery.api_json.ApiJsonStrategy.get_version_info" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_version_info
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#notapkgtool.discovery.api_json.ApiJsonStrategy.validate_config" class="md-nav__link">
    <span class="md-ellipsis">
      
        <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;validate_config
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="discovery">discovery</h1>
<p>The discovery module implements the strategy pattern for obtaining application installers and extracting version information.</p>
<p>NAPT supports two types of discovery strategies:</p>
<ul>
<li>
<p><strong>Version-First Strategies</strong> (web_scrape, api_github, api_json): Discover version without downloading, enabling fast update checks (~100-300ms) and the ability to skip downloads entirely when versions are unchanged.</p>
</li>
<li>
<p><strong>File-First Strategy</strong> (url_download): Must download file to extract version, uses HTTP ETag conditional requests for optimization.</p>
</li>
</ul>


<div class="doc doc-object doc-module">



<h2 id="notapkgtool.discovery.base" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <span class="doc doc-object-name doc-module-name">notapkgtool.discovery.base</span>


</h2>

    <div class="doc doc-contents first">

        <p>Discovery strategy base protocol and registry for NAPT.</p>
<p>This module defines the foundational components for the discovery system:</p>
<ul>
<li>DiscoveryStrategy protocol: Interface that all strategies must implement</li>
<li>Strategy registry: Global dict mapping strategy names to implementations</li>
<li>Registration and lookup functions: register_strategy() and get_strategy()</li>
</ul>
<p>The discovery system uses a strategy pattern to support multiple ways
of obtaining application installers and their versions:</p>
<ul>
<li>http_static: Direct download from a static URL</li>
<li>url_regex: Parse version from URL patterns using regex</li>
<li>github_release: Fetch from GitHub releases API</li>
<li>http_json: Query JSON API endpoints with JSONPath</li>
</ul>


<details class="design-philosophy" open>
  <summary>Design Philosophy</summary>
  <ul>
<li>Strategies are Protocol classes (structural subtyping, not inheritance)</li>
<li>Registration happens at module import time (strategies self-register)</li>
<li>Registry is a simple dict (no complex dependency injection needed)</li>
<li>Each strategy is stateless and can be instantiated on-demand</li>
</ul>
</details>        <p>Protocol Benefits:</p>
<p>Using typing.Protocol instead of ABC allows:</p>
<ul>
<li>Duck typing: Classes don't need explicit inheritance</li>
<li>Better IDE support: Type checkers verify interface compliance</li>
<li>Flexibility: Third-party code can add strategies without touching base</li>
</ul>


<details class="example" open>
  <summary>Example</summary>
  <p>Implementing a custom strategy:</p>
<pre><code>from notapkgtool.discovery.base import register_strategy, DiscoveryStrategy
from pathlib import Path
from typing import Any
from notapkgtool.versioning.keys import DiscoveredVersion

class MyCustomStrategy:
    def discover_version(
        self, app_config: dict[str, Any], output_dir: Path
    ) -&gt; tuple[DiscoveredVersion, Path, str]:
        # Implement your discovery logic here
        ...

# Register it (typically at module import)
register_strategy("my_custom", MyCustomStrategy)

# Now it can be used in recipes:
# source:
#   strategy: my_custom
#   ...
</code></pre>
</details>









  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h3 id="notapkgtool.discovery.base.DiscoveryStrategy" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">DiscoveryStrategy</span>


</h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="typing.Protocol">Protocol</span></code></p>



        <p>Protocol for version discovery strategies.</p>
<p>Each strategy must implement discover_version() which downloads
and extracts version information based on the app config.</p>
<p>Strategies may optionally implement validate_config() to provide
strategy-specific configuration validation without network calls.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>notapkgtool/discovery/base.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DiscoveryStrategy</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Protocol for version discovery strategies.</span>

<span class="sd">    Each strategy must implement discover_version() which downloads</span>
<span class="sd">    and extracts version information based on the app config.</span>

<span class="sd">    Strategies may optionally implement validate_config() to provide</span>
<span class="sd">    strategy-specific configuration validation without network calls.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">discover_version</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">app_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">output_dir</span><span class="p">:</span> <span class="n">Path</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">DiscoveredVersion</span><span class="p">,</span> <span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Discover and download an application version.</span>

<span class="sd">        Args:</span>
<span class="sd">            app_config: The app configuration from the recipe</span>
<span class="sd">                (`config[&quot;apps&quot;][0]`).</span>
<span class="sd">            output_dir: Directory to download the installer to.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A tuple (discovered_version, file_path, sha256, headers), where</span>
<span class="sd">                discovered_version is the version information, file_path is</span>
<span class="sd">                the path to the downloaded file, sha256 is the SHA-256 hash,</span>
<span class="sd">                and headers contains HTTP response headers for caching.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: On discovery or download failures.</span>
<span class="sd">            RuntimeError: On discovery or download failures.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate strategy-specific configuration (optional).</span>

<span class="sd">        This method validates the app configuration for strategy-specific</span>
<span class="sd">        requirements without making network calls or downloading files.</span>
<span class="sd">        Useful for quick feedback during recipe development.</span>

<span class="sd">        Args:</span>
<span class="sd">            app_config: The app configuration from the recipe</span>
<span class="sd">                (`config[&quot;apps&quot;][0]`).</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of error messages. Empty list if configuration is valid.</span>
<span class="sd">            Each error should be a human-readable description of the issue.</span>

<span class="sd">        Example:</span>
<span class="sd">            Check required fields:</span>

<span class="sd">                def validate_config(self, app_config):</span>
<span class="sd">                    errors = []</span>
<span class="sd">                    source = app_config.get(&quot;source&quot;, {})</span>
<span class="sd">                    if &quot;url&quot; not in source:</span>
<span class="sd">                        errors.append(&quot;Missing required field: source.url&quot;)</span>
<span class="sd">                    return errors</span>

<span class="sd">        Note:</span>
<span class="sd">            This method is optional; strategies without it will skip validation.</span>
<span class="sd">            Should NOT make network calls or download files. Should check field</span>
<span class="sd">            presence, types, and format only. Used by &#39;napt validate&#39; command</span>
<span class="sd">            for fast recipe checking.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="notapkgtool.discovery.base.DiscoveryStrategy.discover_version" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">discover_version</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">discover_version</span><span class="p">(</span><span class="n">app_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">output_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">DiscoveredVersion</span><span class="p">,</span> <span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Discover and download an application version.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>app_config</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The app configuration from the recipe
(<code>config["apps"][0]</code>).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_dir</code>
            </td>
            <td>
                  <code><span title="pathlib.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Directory to download the installer to.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="tuple">tuple</span>[<a class="autorefs autorefs-internal" title="            DiscoveredVersion


  
      dataclass
   (notapkgtool.versioning.keys.DiscoveredVersion)" href="../versioning/#notapkgtool.versioning.keys.DiscoveredVersion">DiscoveredVersion</a>, <span title="pathlib.Path">Path</span>, <span title="str">str</span>, <span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A tuple (discovered_version, file_path, sha256, headers), where
discovered_version is the version information, file_path is
the path to the downloaded file, sha256 is the SHA-256 hash,
and headers contains HTTP response headers for caching.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>On discovery or download failures.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="RuntimeError">RuntimeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>On discovery or download failures.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>notapkgtool/discovery/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">discover_version</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">app_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">output_dir</span><span class="p">:</span> <span class="n">Path</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">DiscoveredVersion</span><span class="p">,</span> <span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Discover and download an application version.</span>

<span class="sd">    Args:</span>
<span class="sd">        app_config: The app configuration from the recipe</span>
<span class="sd">            (`config[&quot;apps&quot;][0]`).</span>
<span class="sd">        output_dir: Directory to download the installer to.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A tuple (discovered_version, file_path, sha256, headers), where</span>
<span class="sd">            discovered_version is the version information, file_path is</span>
<span class="sd">            the path to the downloaded file, sha256 is the SHA-256 hash,</span>
<span class="sd">            and headers contains HTTP response headers for caching.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: On discovery or download failures.</span>
<span class="sd">        RuntimeError: On discovery or download failures.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="o">...</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="notapkgtool.discovery.base.DiscoveryStrategy.validate_config" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">validate_config</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">validate_config</span><span class="p">(</span><span class="n">app_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Validate strategy-specific configuration (optional).</p>
<p>This method validates the app configuration for strategy-specific
requirements without making network calls or downloading files.
Useful for quick feedback during recipe development.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>app_config</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The app configuration from the recipe
(<code>config["apps"][0]</code>).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of error messages. Empty list if configuration is valid.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Each error should be a human-readable description of the issue.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <p>Check required fields:</p>
<pre><code>def validate_config(self, app_config):
    errors = []
    source = app_config.get("source", {})
    if "url" not in source:
        errors.append("Missing required field: source.url")
    return errors
</code></pre>
</details>

<details class="note" open>
  <summary>Note</summary>
  <p>This method is optional; strategies without it will skip validation.
Should NOT make network calls or download files. Should check field
presence, types, and format only. Used by 'napt validate' command
for fast recipe checking.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>notapkgtool/discovery/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">validate_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate strategy-specific configuration (optional).</span>

<span class="sd">    This method validates the app configuration for strategy-specific</span>
<span class="sd">    requirements without making network calls or downloading files.</span>
<span class="sd">    Useful for quick feedback during recipe development.</span>

<span class="sd">    Args:</span>
<span class="sd">        app_config: The app configuration from the recipe</span>
<span class="sd">            (`config[&quot;apps&quot;][0]`).</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of error messages. Empty list if configuration is valid.</span>
<span class="sd">        Each error should be a human-readable description of the issue.</span>

<span class="sd">    Example:</span>
<span class="sd">        Check required fields:</span>

<span class="sd">            def validate_config(self, app_config):</span>
<span class="sd">                errors = []</span>
<span class="sd">                source = app_config.get(&quot;source&quot;, {})</span>
<span class="sd">                if &quot;url&quot; not in source:</span>
<span class="sd">                    errors.append(&quot;Missing required field: source.url&quot;)</span>
<span class="sd">                return errors</span>

<span class="sd">    Note:</span>
<span class="sd">        This method is optional; strategies without it will skip validation.</span>
<span class="sd">        Should NOT make network calls or download files. Should check field</span>
<span class="sd">        presence, types, and format only. Used by &#39;napt validate&#39; command</span>
<span class="sd">        for fast recipe checking.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="o">...</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h3 id="notapkgtool.discovery.base.register_strategy" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">register_strategy</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">register_strategy</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">strategy_class</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">DiscoveryStrategy</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Register a discovery strategy by name in the global registry.</p>
<p>This function should be called when a strategy module is imported,
typically at module level. Registering the same name twice will
overwrite the previous registration (allows monkey-patching for tests).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Strategy name (e.g., "http_static"). This is the value
used in recipe YAML files under source.strategy. Names should be
lowercase with underscores for readability.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>strategy_class</code>
            </td>
            <td>
                  <code><span title="type">type</span>[<a class="autorefs autorefs-internal" title="            DiscoveryStrategy (notapkgtool.discovery.base.DiscoveryStrategy)" href="#notapkgtool.discovery.base.DiscoveryStrategy">DiscoveryStrategy</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The strategy class to
register. Must implement the DiscoveryStrategy protocol (have a
discover_version method with the correct signature).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <p>Register at module import time:</p>
<pre><code># In discovery/my_strategy.py
from .base import register_strategy

class MyStrategy:
    def discover_version(self, app_config, output_dir):
        ...

register_strategy("my_strategy", MyStrategy)
</code></pre>
</details>

<details class="note" open>
  <summary>Note</summary>
  <p>No validation is performed at registration time. Type checkers will
verify protocol compliance at static analysis time. Runtime errors
occur at strategy instantiation or invocation.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>notapkgtool/discovery/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">register_strategy</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">strategy_class</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">DiscoveryStrategy</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Register a discovery strategy by name in the global registry.</span>

<span class="sd">    This function should be called when a strategy module is imported,</span>
<span class="sd">    typically at module level. Registering the same name twice will</span>
<span class="sd">    overwrite the previous registration (allows monkey-patching for tests).</span>

<span class="sd">    Args:</span>
<span class="sd">        name: Strategy name (e.g., &quot;http_static&quot;). This is the value</span>
<span class="sd">            used in recipe YAML files under source.strategy. Names should be</span>
<span class="sd">            lowercase with underscores for readability.</span>
<span class="sd">        strategy_class: The strategy class to</span>
<span class="sd">            register. Must implement the DiscoveryStrategy protocol (have a</span>
<span class="sd">            discover_version method with the correct signature).</span>

<span class="sd">    Example:</span>
<span class="sd">        Register at module import time:</span>

<span class="sd">            # In discovery/my_strategy.py</span>
<span class="sd">            from .base import register_strategy</span>

<span class="sd">            class MyStrategy:</span>
<span class="sd">                def discover_version(self, app_config, output_dir):</span>
<span class="sd">                    ...</span>

<span class="sd">            register_strategy(&quot;my_strategy&quot;, MyStrategy)</span>

<span class="sd">    Note:</span>
<span class="sd">        No validation is performed at registration time. Type checkers will</span>
<span class="sd">        verify protocol compliance at static analysis time. Runtime errors</span>
<span class="sd">        occur at strategy instantiation or invocation.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_STRATEGY_REGISTRY</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">strategy_class</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="notapkgtool.discovery.base.get_strategy" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <span class="doc doc-object-name doc-function-name">get_strategy</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get_strategy</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DiscoveryStrategy</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Get a discovery strategy instance by name from the global registry.</p>
<p>The strategy is instantiated on-demand (strategies are stateless, so
a new instance is created for each call). The strategy module must
have been imported first for registration to occur.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Strategy name (e.g., "http_static"). Must exactly match
a name registered via register_strategy(). Case-sensitive.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="            DiscoveryStrategy (notapkgtool.discovery.base.DiscoveryStrategy)" href="#notapkgtool.discovery.base.DiscoveryStrategy">DiscoveryStrategy</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A new instance of the requested strategy, ready
to use.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the strategy name is not registered. The error message
includes a list of available strategies for troubleshooting.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <p>Get and use a strategy:</p>
<pre><code>from notapkgtool.discovery import get_strategy
strategy = get_strategy("http_static")
# Use strategy.discover_version(...)
</code></pre>
<p>Handle unknown strategy:</p>
<pre><code>try:
    strategy = get_strategy("nonexistent")
except ValueError as e:
    print(f"Strategy not found: {e}")
</code></pre>
</details>

<details class="note" open>
  <summary>Note</summary>
  <p>Strategies must be registered before they can be retrieved. The
http_static strategy is auto-registered when imported. New strategies
can be added by creating a module and registering.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>notapkgtool/discovery/base.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_strategy</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DiscoveryStrategy</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a discovery strategy instance by name from the global registry.</span>

<span class="sd">    The strategy is instantiated on-demand (strategies are stateless, so</span>
<span class="sd">    a new instance is created for each call). The strategy module must</span>
<span class="sd">    have been imported first for registration to occur.</span>

<span class="sd">    Args:</span>
<span class="sd">        name: Strategy name (e.g., &quot;http_static&quot;). Must exactly match</span>
<span class="sd">            a name registered via register_strategy(). Case-sensitive.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A new instance of the requested strategy, ready</span>
<span class="sd">            to use.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the strategy name is not registered. The error message</span>
<span class="sd">            includes a list of available strategies for troubleshooting.</span>

<span class="sd">    Example:</span>
<span class="sd">        Get and use a strategy:</span>

<span class="sd">            from notapkgtool.discovery import get_strategy</span>
<span class="sd">            strategy = get_strategy(&quot;http_static&quot;)</span>
<span class="sd">            # Use strategy.discover_version(...)</span>

<span class="sd">        Handle unknown strategy:</span>

<span class="sd">            try:</span>
<span class="sd">                strategy = get_strategy(&quot;nonexistent&quot;)</span>
<span class="sd">            except ValueError as e:</span>
<span class="sd">                print(f&quot;Strategy not found: {e}&quot;)</span>

<span class="sd">    Note:</span>
<span class="sd">        Strategies must be registered before they can be retrieved. The</span>
<span class="sd">        http_static strategy is auto-registered when imported. New strategies</span>
<span class="sd">        can be added by creating a module and registering.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_STRATEGY_REGISTRY</span><span class="p">:</span>
        <span class="n">available</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_STRATEGY_REGISTRY</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unknown discovery strategy: </span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="s2">. Available: </span><span class="si">{</span><span class="n">available</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;(none)&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">_STRATEGY_REGISTRY</span><span class="p">[</span><span class="n">name</span><span class="p">]()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="notapkgtool.discovery.url_download" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <span class="doc doc-object-name doc-module-name">notapkgtool.discovery.url_download</span>


</h2>

    <div class="doc doc-contents first">

        <p>URL download discovery strategy for NAPT.</p>
<p>This is a FILE-FIRST strategy that downloads an installer from a fixed HTTP(S)
URL and extracts version information from the downloaded file. Uses HTTP ETag
conditional requests to avoid re-downloading unchanged files.</p>
<p>Key Advantages:</p>
<ul>
<li>Works with any fixed URL (version not required in URL)</li>
<li>Extracts accurate version directly from installer metadata</li>
<li>Uses ETag-based conditional requests for efficiency (~500ms vs full download)</li>
<li>Simple and reliable for vendors with stable download URLs</li>
<li>Fallback strategy when version not available via API/URL pattern</li>
</ul>
<p>Supported Version Extraction:</p>
<ul>
<li>msi: Extract ProductVersion property from MSI files</li>
<li>(Future) exe: Extract FileVersion from PE headers</li>
<li>(Future) manual: Use a version specified in the recipe</li>
</ul>
<p>Use Cases:</p>
<ul>
<li>Google Chrome: Fixed enterprise MSI URL, version embedded in MSI</li>
<li>Mozilla Firefox: Fixed enterprise MSI URL, version embedded in MSI</li>
<li>Vendors with stable download URLs and embedded version metadata</li>
<li>When version not available via API, URL pattern, or GitHub tags</li>
</ul>
<p>Recipe Configuration:</p>
<pre><code>source:
  strategy: url_download
  url: "https://vendor.com/installer.msi"          # Required: download URL
  version:
    type: msi                                      # Required: extraction method
    file: "installer.msi"                          # Optional: defaults to URL filename
</code></pre>
<p>Configuration Fields:</p>
<ul>
<li><strong>url</strong> (str, required): HTTP(S) URL to download the installer from. The URL should be stable and point to the latest version.</li>
<li><strong>version.type</strong> (str, required): Version extraction method. Currently supported: msi.</li>
<li><strong>version.file</strong> (str, optional): Specific filename to extract version from. Defaults to the downloaded filename derived from the URL or Content-Disposition header.</li>
</ul>
<p>Error Handling:</p>
<ul>
<li>ValueError: Missing or invalid configuration fields</li>
<li>RuntimeError: Download failures, version extraction errors</li>
<li>Errors are chained with 'from err' for better debugging</li>
</ul>
<p>Example:
In a recipe YAML:</p>
<pre><code>apps:
  - name: "My App"
    id: "my-app"
    source:
      strategy: url_download
      url: "https://example.com/myapp-setup.msi"
      version:
        type: msi
</code></pre>
<p>From Python:</p>
<pre><code>from pathlib import Path
from notapkgtool.discovery.url_download import UrlDownloadStrategy

strategy = UrlDownloadStrategy()
app_config = {
    "source": {
        "url": "https://example.com/app.msi",
        "version": {"type": "msi"},
    }
}

# With cache for ETag optimization
cache = {"etag": 'W/"abc123"', "sha256": "..."}
discovered, file_path, sha256, headers = strategy.discover_version(
    app_config, Path("./downloads"), cache=cache
)
print(f"Version {discovered.version} at {file_path}")
</code></pre>
<p>From Python (using core orchestration):</p>
<pre><code>from pathlib import Path
from notapkgtool.core import discover_recipe

# Automatically uses ETag optimization
result = discover_recipe(Path("recipe.yaml"), Path("./downloads"))
print(f"Version {result['version']} at {result['file_path']}")
</code></pre>


<details class="note" open>
  <summary>Note</summary>
  <ul>
<li>Must download file to extract version (architectural constraint)</li>
<li>ETag optimization reduces bandwidth but still requires network round-trip</li>
<li>Core orchestration automatically provides cached ETag if available</li>
<li>Server must support ETag or Last-Modified headers for optimization</li>
<li>If server doesn't support conditional requests, full download occurs every time</li>
<li>Consider version-first strategies (web_scrape, api_github, api_json) for
  better performance when version available via web scraping or API</li>
</ul>
</details>









  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h3 id="notapkgtool.discovery.url_download.UrlDownloadStrategy" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">UrlDownloadStrategy</span>


</h3>


    <div class="doc doc-contents ">



        <p>Discovery strategy for static HTTP(S) URLs.</p>


<details class="configuration-example" open>
  <summary>Configuration example</summary>
  <p>source:
  strategy: url_download
  url: "https://example.com/installer.msi"
  version:
    type: msi
    file: "installer.msi"</p>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>notapkgtool/discovery/url_download.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">UrlDownloadStrategy</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Discovery strategy for static HTTP(S) URLs.</span>

<span class="sd">    Configuration example:</span>
<span class="sd">        source:</span>
<span class="sd">          strategy: url_download</span>
<span class="sd">          url: &quot;https://example.com/installer.msi&quot;</span>
<span class="sd">          version:</span>
<span class="sd">            type: msi</span>
<span class="sd">            file: &quot;installer.msi&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">discover_version</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">app_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">output_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">cache</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">DiscoveredVersion</span><span class="p">,</span> <span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Download from static URL and extract version from the file.</span>

<span class="sd">        Args:</span>
<span class="sd">            app_config: App configuration containing source.url and</span>
<span class="sd">                source.version.</span>
<span class="sd">            output_dir: Directory to save the downloaded file.</span>
<span class="sd">            cache: Cached state with etag, last_modified,</span>
<span class="sd">                file_path, and sha256 for conditional requests. If provided</span>
<span class="sd">                and file is unchanged (HTTP 304), the cached file is returned.</span>
<span class="sd">            verbose: If True, print verbose logging messages.</span>
<span class="sd">                Default is False.</span>
<span class="sd">            debug: If True, print debug logging messages.</span>
<span class="sd">                Default is False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A tuple (version_info, file_path, sha256, headers), where</span>
<span class="sd">                version_info contains the discovered version information,</span>
<span class="sd">                file_path is the Path to the downloaded file, sha256 is the</span>
<span class="sd">                SHA-256 hash, and headers contains HTTP response headers.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If required config fields are missing or invalid.</span>
<span class="sd">            RuntimeError: If download or version extraction fails.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">notapkgtool.cli</span><span class="w"> </span><span class="kn">import</span> <span class="n">print_verbose</span>

        <span class="n">source</span> <span class="o">=</span> <span class="n">app_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;url_download strategy requires &#39;source.url&#39; in config&quot;</span><span class="p">)</span>

        <span class="n">version_config</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;version&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">version_type</span> <span class="o">=</span> <span class="n">version_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">version_type</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;url_download strategy requires &#39;source.version.type&#39; in config&quot;</span>
            <span class="p">)</span>

        <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="s2">&quot;Strategy: url_download (file-first)&quot;</span><span class="p">)</span>
        <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Source URL: </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Version extraction: </span><span class="si">{</span><span class="n">version_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Extract ETag/Last-Modified from cache if available</span>
        <span class="n">etag</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;etag&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">cache</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">last_modified</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;last_modified&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">cache</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">etag</span><span class="p">:</span>
            <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Using cached ETag: </span><span class="si">{</span><span class="n">etag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">last_modified</span><span class="p">:</span>
            <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Using cached Last-Modified: </span><span class="si">{</span><span class="n">last_modified</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Download the file (with conditional request if cache available)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">file_path</span><span class="p">,</span> <span class="n">sha256</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span>
                <span class="n">url</span><span class="p">,</span>
                <span class="n">output_dir</span><span class="p">,</span>
                <span class="n">etag</span><span class="o">=</span><span class="n">etag</span><span class="p">,</span>
                <span class="n">last_modified</span><span class="o">=</span><span class="n">last_modified</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">NotModifiedError</span><span class="p">:</span>
            <span class="c1"># File unchanged (HTTP 304), use cached version</span>
            <span class="c1"># Use convention-based path: derive filename from URL</span>
            <span class="n">print_verbose</span><span class="p">(</span>
                <span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="s2">&quot;File not modified (HTTP 304), using cached version&quot;</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">cache</span> <span class="ow">or</span> <span class="s2">&quot;sha256&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cache</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s2">&quot;Cache indicates file not modified, but missing SHA-256. &quot;</span>
                    <span class="s2">&quot;Try running with --stateless to force re-download.&quot;</span>
                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

            <span class="c1"># Derive file path from URL (convention-based, schema v2)</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">urlparse</span>

            <span class="n">filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
            <span class="n">cached_file</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="n">filename</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">cached_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Cached file </span><span class="si">{</span><span class="n">cached_file</span><span class="si">}</span><span class="s2"> not found. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;File may have been deleted. Try running with --stateless.&quot;</span>
                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

            <span class="c1"># Extract version from cached file</span>
            <span class="k">if</span> <span class="n">version_type</span> <span class="o">==</span> <span class="s2">&quot;msi&quot;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">discovered</span> <span class="o">=</span> <span class="n">version_from_msi_product_version</span><span class="p">(</span>
                        <span class="n">cached_file</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Failed to extract MSI ProductVersion from cached file </span><span class="si">{</span><span class="n">cached_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unsupported version type: </span><span class="si">{</span><span class="n">version_type</span><span class="si">!r}</span><span class="s2">. &quot;</span> <span class="sa">f</span><span class="s2">&quot;Supported: msi&quot;</span>
                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

            <span class="c1"># Return cached info with preserved headers (prevents overwriting ETag)</span>
            <span class="c1"># When 304, no new headers received, so return cached values to preserve them</span>
            <span class="n">preserved_headers</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;etag&quot;</span><span class="p">):</span>
                <span class="n">preserved_headers</span><span class="p">[</span><span class="s2">&quot;ETag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cache</span><span class="p">[</span><span class="s2">&quot;etag&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;last_modified&quot;</span><span class="p">):</span>
                <span class="n">preserved_headers</span><span class="p">[</span><span class="s2">&quot;Last-Modified&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cache</span><span class="p">[</span><span class="s2">&quot;last_modified&quot;</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">discovered</span><span class="p">,</span> <span class="n">cached_file</span><span class="p">,</span> <span class="n">cache</span><span class="p">[</span><span class="s2">&quot;sha256&quot;</span><span class="p">],</span> <span class="n">preserved_headers</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)):</span>
                <span class="k">raise</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to download </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>

        <span class="c1"># File was downloaded (not cached), extract version from it</span>
        <span class="k">if</span> <span class="n">version_type</span> <span class="o">==</span> <span class="s2">&quot;msi&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">discovered</span> <span class="o">=</span> <span class="n">version_from_msi_product_version</span><span class="p">(</span>
                    <span class="n">file_path</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Failed to extract MSI ProductVersion from </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unsupported version type: </span><span class="si">{</span><span class="n">version_type</span><span class="si">!r}</span><span class="s2">. &quot;</span> <span class="sa">f</span><span class="s2">&quot;Supported: msi&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">discovered</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">sha256</span><span class="p">,</span> <span class="n">headers</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate url_download strategy configuration.</span>

<span class="sd">        Checks for required fields and correct types without making network calls.</span>

<span class="sd">        Args:</span>
<span class="sd">            app_config: The app configuration from the recipe.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of error messages (empty if valid).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">app_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="c1"># Check required fields</span>
        <span class="k">if</span> <span class="s2">&quot;url&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Missing required field: source.url&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.url must be a string&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.url cannot be empty&quot;</span><span class="p">)</span>

        <span class="c1"># Check version configuration</span>
        <span class="k">if</span> <span class="s2">&quot;version&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Missing required field: source.version&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.version must be a dictionary&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">version_config</span> <span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span>

            <span class="c1"># Check version.type</span>
            <span class="k">if</span> <span class="s2">&quot;type&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">version_config</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Missing required field: source.version.type&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">version_config</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.version.type must be a string&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">version_type</span> <span class="o">=</span> <span class="n">version_config</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
                <span class="n">supported_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;msi&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">version_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">supported_types</span><span class="p">:</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Unsupported source.version.type: </span><span class="si">{</span><span class="n">version_type</span><span class="si">!r}</span><span class="s2">. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Supported: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">supported_types</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

        <span class="k">return</span> <span class="n">errors</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="notapkgtool.discovery.url_download.UrlDownloadStrategy.discover_version" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">discover_version</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">discover_version</span><span class="p">(</span><span class="n">app_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">output_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">cache</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">DiscoveredVersion</span><span class="p">,</span> <span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Download from static URL and extract version from the file.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>app_config</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>App configuration containing source.url and
source.version.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_dir</code>
            </td>
            <td>
                  <code><span title="pathlib.Path">Path</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Directory to save the downloaded file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cache</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Cached state with etag, last_modified,
file_path, and sha256 for conditional requests. If provided
and file is unchanged (HTTP 304), the cached file is returned.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>verbose</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, print verbose logging messages.
Default is False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>debug</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, print debug logging messages.
Default is False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="tuple">tuple</span>[<a class="autorefs autorefs-internal" title="            DiscoveredVersion


  
      dataclass
   (notapkgtool.versioning.keys.DiscoveredVersion)" href="../versioning/#notapkgtool.versioning.keys.DiscoveredVersion">DiscoveredVersion</a>, <span title="pathlib.Path">Path</span>, <span title="str">str</span>, <span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A tuple (version_info, file_path, sha256, headers), where
version_info contains the discovered version information,
file_path is the Path to the downloaded file, sha256 is the
SHA-256 hash, and headers contains HTTP response headers.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If required config fields are missing or invalid.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="RuntimeError">RuntimeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If download or version extraction fails.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>notapkgtool/discovery/url_download.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">discover_version</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">app_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">output_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">cache</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">DiscoveredVersion</span><span class="p">,</span> <span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Download from static URL and extract version from the file.</span>

<span class="sd">    Args:</span>
<span class="sd">        app_config: App configuration containing source.url and</span>
<span class="sd">            source.version.</span>
<span class="sd">        output_dir: Directory to save the downloaded file.</span>
<span class="sd">        cache: Cached state with etag, last_modified,</span>
<span class="sd">            file_path, and sha256 for conditional requests. If provided</span>
<span class="sd">            and file is unchanged (HTTP 304), the cached file is returned.</span>
<span class="sd">        verbose: If True, print verbose logging messages.</span>
<span class="sd">            Default is False.</span>
<span class="sd">        debug: If True, print debug logging messages.</span>
<span class="sd">            Default is False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A tuple (version_info, file_path, sha256, headers), where</span>
<span class="sd">            version_info contains the discovered version information,</span>
<span class="sd">            file_path is the Path to the downloaded file, sha256 is the</span>
<span class="sd">            SHA-256 hash, and headers contains HTTP response headers.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If required config fields are missing or invalid.</span>
<span class="sd">        RuntimeError: If download or version extraction fails.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">notapkgtool.cli</span><span class="w"> </span><span class="kn">import</span> <span class="n">print_verbose</span>

    <span class="n">source</span> <span class="o">=</span> <span class="n">app_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;url_download strategy requires &#39;source.url&#39; in config&quot;</span><span class="p">)</span>

    <span class="n">version_config</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;version&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">version_type</span> <span class="o">=</span> <span class="n">version_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">version_type</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;url_download strategy requires &#39;source.version.type&#39; in config&quot;</span>
        <span class="p">)</span>

    <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="s2">&quot;Strategy: url_download (file-first)&quot;</span><span class="p">)</span>
    <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Source URL: </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Version extraction: </span><span class="si">{</span><span class="n">version_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Extract ETag/Last-Modified from cache if available</span>
    <span class="n">etag</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;etag&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">cache</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">last_modified</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;last_modified&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">cache</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">etag</span><span class="p">:</span>
        <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Using cached ETag: </span><span class="si">{</span><span class="n">etag</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">last_modified</span><span class="p">:</span>
        <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Using cached Last-Modified: </span><span class="si">{</span><span class="n">last_modified</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Download the file (with conditional request if cache available)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">file_path</span><span class="p">,</span> <span class="n">sha256</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span>
            <span class="n">url</span><span class="p">,</span>
            <span class="n">output_dir</span><span class="p">,</span>
            <span class="n">etag</span><span class="o">=</span><span class="n">etag</span><span class="p">,</span>
            <span class="n">last_modified</span><span class="o">=</span><span class="n">last_modified</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
            <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="n">NotModifiedError</span><span class="p">:</span>
        <span class="c1"># File unchanged (HTTP 304), use cached version</span>
        <span class="c1"># Use convention-based path: derive filename from URL</span>
        <span class="n">print_verbose</span><span class="p">(</span>
            <span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="s2">&quot;File not modified (HTTP 304), using cached version&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">cache</span> <span class="ow">or</span> <span class="s2">&quot;sha256&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cache</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Cache indicates file not modified, but missing SHA-256. &quot;</span>
                <span class="s2">&quot;Try running with --stateless to force re-download.&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

        <span class="c1"># Derive file path from URL (convention-based, schema v2)</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">urlparse</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
        <span class="n">cached_file</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="n">filename</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">cached_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cached file </span><span class="si">{</span><span class="n">cached_file</span><span class="si">}</span><span class="s2"> not found. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;File may have been deleted. Try running with --stateless.&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

        <span class="c1"># Extract version from cached file</span>
        <span class="k">if</span> <span class="n">version_type</span> <span class="o">==</span> <span class="s2">&quot;msi&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">discovered</span> <span class="o">=</span> <span class="n">version_from_msi_product_version</span><span class="p">(</span>
                    <span class="n">cached_file</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Failed to extract MSI ProductVersion from cached file </span><span class="si">{</span><span class="n">cached_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unsupported version type: </span><span class="si">{</span><span class="n">version_type</span><span class="si">!r}</span><span class="s2">. &quot;</span> <span class="sa">f</span><span class="s2">&quot;Supported: msi&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

        <span class="c1"># Return cached info with preserved headers (prevents overwriting ETag)</span>
        <span class="c1"># When 304, no new headers received, so return cached values to preserve them</span>
        <span class="n">preserved_headers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;etag&quot;</span><span class="p">):</span>
            <span class="n">preserved_headers</span><span class="p">[</span><span class="s2">&quot;ETag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cache</span><span class="p">[</span><span class="s2">&quot;etag&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;last_modified&quot;</span><span class="p">):</span>
            <span class="n">preserved_headers</span><span class="p">[</span><span class="s2">&quot;Last-Modified&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cache</span><span class="p">[</span><span class="s2">&quot;last_modified&quot;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">discovered</span><span class="p">,</span> <span class="n">cached_file</span><span class="p">,</span> <span class="n">cache</span><span class="p">[</span><span class="s2">&quot;sha256&quot;</span><span class="p">],</span> <span class="n">preserved_headers</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)):</span>
            <span class="k">raise</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to download </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>

    <span class="c1"># File was downloaded (not cached), extract version from it</span>
    <span class="k">if</span> <span class="n">version_type</span> <span class="o">==</span> <span class="s2">&quot;msi&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">discovered</span> <span class="o">=</span> <span class="n">version_from_msi_product_version</span><span class="p">(</span>
                <span class="n">file_path</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to extract MSI ProductVersion from </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unsupported version type: </span><span class="si">{</span><span class="n">version_type</span><span class="si">!r}</span><span class="s2">. &quot;</span> <span class="sa">f</span><span class="s2">&quot;Supported: msi&quot;</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">discovered</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">sha256</span><span class="p">,</span> <span class="n">headers</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="notapkgtool.discovery.url_download.UrlDownloadStrategy.validate_config" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">validate_config</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">validate_config</span><span class="p">(</span><span class="n">app_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Validate url_download strategy configuration.</p>
<p>Checks for required fields and correct types without making network calls.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>app_config</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The app configuration from the recipe.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of error messages (empty if valid).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>notapkgtool/discovery/url_download.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">validate_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate url_download strategy configuration.</span>

<span class="sd">    Checks for required fields and correct types without making network calls.</span>

<span class="sd">    Args:</span>
<span class="sd">        app_config: The app configuration from the recipe.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of error messages (empty if valid).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">app_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="p">{})</span>

    <span class="c1"># Check required fields</span>
    <span class="k">if</span> <span class="s2">&quot;url&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Missing required field: source.url&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.url must be a string&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.url cannot be empty&quot;</span><span class="p">)</span>

    <span class="c1"># Check version configuration</span>
    <span class="k">if</span> <span class="s2">&quot;version&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Missing required field: source.version&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.version must be a dictionary&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">version_config</span> <span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span>

        <span class="c1"># Check version.type</span>
        <span class="k">if</span> <span class="s2">&quot;type&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">version_config</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Missing required field: source.version.type&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">version_config</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.version.type must be a string&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">version_type</span> <span class="o">=</span> <span class="n">version_config</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
            <span class="n">supported_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;msi&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">version_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">supported_types</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unsupported source.version.type: </span><span class="si">{</span><span class="n">version_type</span><span class="si">!r}</span><span class="s2">. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Supported: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">supported_types</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

    <span class="k">return</span> <span class="n">errors</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="notapkgtool.discovery.web_scrape" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <span class="doc doc-object-name doc-module-name">notapkgtool.discovery.web_scrape</span>


</h2>

    <div class="doc doc-contents first">

        <p>Web scraping discovery strategy for NAPT.</p>
<p>This is a VERSION-FIRST strategy that scrapes vendor download pages to find
download links and extract version information from those links. This enables
version discovery for vendors that don't provide APIs or static URLs.</p>
<p>Key Advantages:</p>
<ul>
<li>Discovers versions from vendor download pages</li>
<li>Works for vendors without APIs or GitHub releases</li>
<li>Version-first caching (can skip downloads when version unchanged)</li>
<li>Supports both CSS selectors (recommended) and regex (fallback)</li>
<li>No dependency on HTML structure stability (with good selectors)</li>
<li>Handles relative and absolute URLs automatically</li>
</ul>
<p>Supported Link Finding:</p>
<ul>
<li>CSS selectors: Modern, robust, recommended approach</li>
<li>Regex patterns: Fallback for edge cases or when CSS won't work</li>
</ul>
<p>Version Extraction:</p>
<ul>
<li>Extract version from the discovered download URL using regex</li>
<li>Support for captured groups with formatting</li>
<li>Transform version numbers (e.g., "2501" -&gt; "25.01")</li>
</ul>
<p>Use Cases:</p>
<ul>
<li>Vendors with download pages listing multiple versions (7-Zip, etc.)</li>
<li>Legacy software without modern APIs</li>
<li>Small vendors with simple download pages</li>
<li>When GitHub releases and JSON APIs aren't available</li>
</ul>
<p>Recipe Configuration:</p>
<pre><code>source:
  strategy: web_scrape
  page_url: "https://www.7-zip.org/download.html"
  link_selector: 'a[href$="-x64.msi"]'        # CSS (recommended)
  version_pattern: "7z(\d{2})(\d{2})-x64"   # Extract from URL
  version_format: "{0}.{1}"                    # Transform to "25.01"
</code></pre>
<p>Alternative with regex:</p>
<pre><code>source:
  strategy: web_scrape
  page_url: "https://vendor.com/downloads"
  link_pattern: 'href="(/files/app-v[0-9.]+-x64\.msi)"'
  version_pattern: "app-v([0-9.]+)-x64"
</code></pre>
<p>Configuration Fields:</p>
<ul>
<li><strong>page_url</strong> (str, required): URL of the page to scrape for download links</li>
<li><strong>link_selector</strong> (str, optional): CSS selector to find download link. Recommended approach. Example: 'a[href$=".msi"]' finds links ending with .msi</li>
<li><strong>link_pattern</strong> (str, optional): Regex pattern as fallback when CSS won't work. Must have one capture group for the URL. Example: 'href="([^"]*.msi)"'</li>
<li><strong>version_pattern</strong> (str, required): Regex pattern to extract version from the discovered URL. Use capture groups to extract version parts. Example: "app-(\d+.\d+)" or "7z(\d{2})(\d{2})"</li>
<li><strong>version_format</strong> (str, optional): Python format string to combine captured groups. Use {0}, {1}, etc. for groups. Example: "{0}.{1}" transforms captures "25", "01" into "25.01". Defaults to "{0}" (first capture group only).</li>
</ul>
<p>Error Handling:</p>
<ul>
<li>ValueError: Missing or invalid configuration fields</li>
<li>RuntimeError: Page download failures, selector/pattern not found</li>
<li>Errors are chained with 'from err' for better debugging</li>
</ul>
<p>Finding CSS Selectors:</p>
<pre><code>Use browser DevTools:

1. Open download page in Chrome/Edge/Firefox
2. Right-click download link -&gt; Inspect
3. Right-click highlighted element -&gt; Copy -&gt; Copy selector
4. Simplify selector (e.g., 'a[href$=".msi"]' instead of complex nth-child)
</code></pre>
<p>Common CSS Patterns:</p>
<ul>
<li>'a[href$=".msi"]' - Links ending with .msi</li>
<li>'a[href*="x64"]' - Links containing "x64"</li>
<li>'a.download' - Links with class="download"</li>
<li>'a[href$="-x64.msi"]:first-of-type' - First matching link</li>
</ul>
<p>Example:
In a recipe YAML:</p>
<pre><code>apps:
  - name: "7-Zip"
    id: "napt-7zip"
    source:
      strategy: web_scrape
      page_url: "https://www.7-zip.org/download.html"
      link_selector: 'a[href$="-x64.msi"]'
      version_pattern: "7z(\d{2})(\d{2})-x64"
      version_format: "{0}.{1}"
</code></pre>
<p>From Python (version-first approach):</p>
<pre><code>from notapkgtool.discovery.web_scrape import WebScrapeStrategy
from notapkgtool.io import download_file

strategy = WebScrapeStrategy()
app_config = {
    "source": {
        "page_url": "https://www.7-zip.org/download.html",
        "link_selector": 'a[href$="-x64.msi"]',
        "version_pattern": "7z(\d{2})(\d{2})-x64",
        "version_format": "{0}.{1}",
    }
}

# Get version WITHOUT downloading installer
version_info = strategy.get_version_info(app_config)
print(f"Latest version: {version_info.version}")

# Download only if needed
if need_to_download:
    file_path, sha256, headers = download_file(
        version_info.download_url, Path("./downloads")
    )
    print(f"Downloaded to {file_path}")
</code></pre>
<p>From Python (using core orchestration):</p>
<pre><code>from pathlib import Path
from notapkgtool.core import discover_recipe

# Automatically uses version-first optimization
result = discover_recipe(Path("recipe.yaml"), Path("./downloads"))
print(f"Version {result['version']} at {result['file_path']}")
</code></pre>


<details class="note" open>
  <summary>Note</summary>
  <ul>
<li>Version discovery via web scraping (no installer download required)</li>
<li>Core orchestration automatically skips download if version unchanged</li>
<li>CSS selectors are recommended (more robust than regex)</li>
<li>Use browser DevTools to find selectors easily</li>
<li>Selector should match exactly one link (first match is used)</li>
<li>BeautifulSoup4 required for CSS selectors</li>
<li>Regex fallback works without BeautifulSoup</li>
</ul>
</details>









  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h3 id="notapkgtool.discovery.web_scrape.WebScrapeStrategy" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">WebScrapeStrategy</span>


</h3>


    <div class="doc doc-contents ">



        <p>Discovery strategy for web scraping download pages.</p>


<details class="configuration-example" open>
  <summary>Configuration example</summary>
  <p>source:
  strategy: web_scrape
  page_url: "https://vendor.com/download.html"
  link_selector: 'a[href$=".msi"]'
  version_pattern: "app-v([0-9.]+)"</p>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>notapkgtool/discovery/web_scrape.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">WebScrapeStrategy</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Discovery strategy for web scraping download pages.</span>

<span class="sd">    Configuration example:</span>
<span class="sd">        source:</span>
<span class="sd">          strategy: web_scrape</span>
<span class="sd">          page_url: &quot;https://vendor.com/download.html&quot;</span>
<span class="sd">          link_selector: &#39;a[href$=&quot;.msi&quot;]&#39;</span>
<span class="sd">          version_pattern: &quot;app-v([0-9.]+)&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_version_info</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">app_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">VersionInfo</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Scrape download page for version and URL without downloading (version-first path).</span>

<span class="sd">        This method scrapes an HTML page, finds a download link using CSS selector</span>
<span class="sd">        or regex, extracts the version from that link, and returns version info.</span>
<span class="sd">        If the version matches cached state, the download can be skipped entirely.</span>

<span class="sd">        Args:</span>
<span class="sd">            app_config: App configuration containing source.page_url,</span>
<span class="sd">                source.link_selector or source.link_pattern, and</span>
<span class="sd">                source.version_pattern.</span>
<span class="sd">            verbose: If True, print verbose logging messages.</span>
<span class="sd">                Defaults to False.</span>
<span class="sd">            debug: If True, print debug logging messages.</span>
<span class="sd">                Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Version info with version string, download URL, and</span>
<span class="sd">                source name.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If required config fields are missing, invalid, or if</span>
<span class="sd">                selectors/patterns don&#39;t match anything.</span>
<span class="sd">            RuntimeError: If page download fails (chained with &#39;from err&#39;).</span>

<span class="sd">        Example:</span>
<span class="sd">            Scrape 7-Zip download page:</span>

<span class="sd">                strategy = WebScrapeStrategy()</span>
<span class="sd">                config = {</span>
<span class="sd">                    &quot;source&quot;: {</span>
<span class="sd">                        &quot;page_url&quot;: &quot;https://www.7-zip.org/download.html&quot;,</span>
<span class="sd">                        &quot;link_selector&quot;: &#39;a[href$=&quot;-x64.msi&quot;]&#39;,</span>
<span class="sd">                        &quot;version_pattern&quot;: &quot;7z(\\d{2})(\\d{2})-x64&quot;,</span>
<span class="sd">                        &quot;version_format&quot;: &quot;{0}.{1}&quot;</span>
<span class="sd">                    }</span>
<span class="sd">                }</span>
<span class="sd">                version_info = strategy.get_version_info(config)</span>
<span class="sd">                # version_info.version returns: &#39;25.01&#39;</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">notapkgtool.cli</span><span class="w"> </span><span class="kn">import</span> <span class="n">print_verbose</span>

        <span class="c1"># Validate configuration</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">app_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">page_url</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;page_url&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">page_url</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;web_scrape strategy requires &#39;source.page_url&#39; in config&quot;</span><span class="p">)</span>

        <span class="n">link_selector</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;link_selector&quot;</span><span class="p">)</span>
        <span class="n">link_pattern</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;link_pattern&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">link_selector</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">link_pattern</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;web_scrape strategy requires either &#39;source.link_selector&#39; or &quot;</span>
                <span class="s2">&quot;&#39;source.link_pattern&#39; in config&quot;</span>
            <span class="p">)</span>

        <span class="n">version_pattern</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;version_pattern&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">version_pattern</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;web_scrape strategy requires &#39;source.version_pattern&#39; in config&quot;</span>
            <span class="p">)</span>

        <span class="n">version_format</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;version_format&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="s2">&quot;Strategy: web_scrape (version-first)&quot;</span><span class="p">)</span>
        <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Page URL: </span><span class="si">{</span><span class="n">page_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">link_selector</span><span class="p">:</span>
            <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Link selector (CSS): </span><span class="si">{</span><span class="n">link_selector</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">link_pattern</span><span class="p">:</span>
            <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Link pattern (regex): </span><span class="si">{</span><span class="n">link_pattern</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Version pattern: </span><span class="si">{</span><span class="n">version_pattern</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Download the HTML page</span>
        <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Fetching page: </span><span class="si">{</span><span class="n">page_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">page_url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
            <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to fetch page: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to fetch page: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>

        <span class="n">html_content</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span>
        <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Page fetched (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">html_content</span><span class="p">)</span><span class="si">}</span><span class="s2"> bytes)&quot;</span><span class="p">)</span>

        <span class="c1"># Find download link using CSS selector or regex</span>
        <span class="n">download_url</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">link_selector</span><span class="p">:</span>
            <span class="c1"># Use CSS selector with BeautifulSoup4</span>
            <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">html_content</span><span class="p">,</span> <span class="s2">&quot;html.parser&quot;</span><span class="p">)</span>
            <span class="n">element</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">select_one</span><span class="p">(</span><span class="n">link_selector</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">element</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;CSS selector </span><span class="si">{</span><span class="n">link_selector</span><span class="si">!r}</span><span class="s2"> did not match any elements on page&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Get href attribute</span>
            <span class="n">href</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">href</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Element matched by </span><span class="si">{</span><span class="n">link_selector</span><span class="si">!r}</span><span class="s2"> has no href attribute&quot;</span>
                <span class="p">)</span>

            <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Found link via CSS: </span><span class="si">{</span><span class="n">href</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Build absolute URL</span>
            <span class="n">download_url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="n">page_url</span><span class="p">,</span> <span class="n">href</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">link_pattern</span><span class="p">:</span>
            <span class="c1"># Use regex fallback</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">link_pattern</span><span class="p">)</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">html_content</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Regex pattern </span><span class="si">{</span><span class="n">link_pattern</span><span class="si">!r}</span><span class="s2"> did not match anything on page&quot;</span>
                    <span class="p">)</span>

                <span class="c1"># Get first capture group or full match</span>
                <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">groups</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">href</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">href</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Found link via regex: </span><span class="si">{</span><span class="n">href</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Build absolute URL</span>
                <span class="n">download_url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="n">page_url</span><span class="p">,</span> <span class="n">href</span><span class="p">)</span>

            <span class="k">except</span> <span class="n">re</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Invalid link_pattern regex: </span><span class="si">{</span><span class="n">link_pattern</span><span class="si">!r}</span><span class="s2">&quot;</span>
                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>

        <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Download URL: </span><span class="si">{</span><span class="n">download_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Extract version from the download URL</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">version_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">version_pattern</span><span class="p">)</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">version_regex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">download_url</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Version pattern </span><span class="si">{</span><span class="n">version_pattern</span><span class="si">!r}</span><span class="s2"> did not match URL </span><span class="si">{</span><span class="n">download_url</span><span class="si">!r}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Get captured groups</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">groups</span><span class="p">:</span>
                <span class="c1"># No capture groups, use full match</span>
                <span class="n">version_str</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Format using captured groups</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">version_str</span> <span class="o">=</span> <span class="n">version_format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">groups</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;version_format </span><span class="si">{</span><span class="n">version_format</span><span class="si">!r}</span><span class="s2"> failed with groups </span><span class="si">{</span><span class="n">groups</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>

        <span class="k">except</span> <span class="n">re</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid version_pattern regex: </span><span class="si">{</span><span class="n">version_pattern</span><span class="si">!r}</span><span class="s2">&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>

        <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Extracted version: </span><span class="si">{</span><span class="n">version_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">VersionInfo</span><span class="p">(</span>
            <span class="n">version</span><span class="o">=</span><span class="n">version_str</span><span class="p">,</span>
            <span class="n">download_url</span><span class="o">=</span><span class="n">download_url</span><span class="p">,</span>
            <span class="n">source</span><span class="o">=</span><span class="s2">&quot;web_scrape&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate web_scrape strategy configuration.</span>

<span class="sd">        Checks for required fields and correct types without making network calls.</span>

<span class="sd">        Args:</span>
<span class="sd">            app_config: The app configuration from the recipe.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of error messages (empty if valid).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">app_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="c1"># Check page_url</span>
        <span class="k">if</span> <span class="s2">&quot;page_url&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Missing required field: source.page_url&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;page_url&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.page_url must be a string&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;page_url&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.page_url cannot be empty&quot;</span><span class="p">)</span>

        <span class="c1"># Check that at least one link finding method is provided</span>
        <span class="n">link_selector</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;link_selector&quot;</span><span class="p">)</span>
        <span class="n">link_pattern</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;link_pattern&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">link_selector</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">link_pattern</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;Missing required field: must provide either source.link_selector or source.link_pattern&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Validate link_selector if provided</span>
        <span class="k">if</span> <span class="n">link_selector</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">link_selector</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.link_selector must be a string&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">link_selector</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.link_selector cannot be empty&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Try to validate CSS selector syntax</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Test if selector is parseable</span>
                    <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="s2">&quot;&lt;html&gt;&lt;/html&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;html.parser&quot;</span><span class="p">)</span>
                    <span class="n">soup</span><span class="o">.</span><span class="n">select_one</span><span class="p">(</span><span class="n">link_selector</span><span class="p">)</span>  <span class="c1"># Will raise if invalid</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid CSS selector: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Validate link_pattern if provided</span>
        <span class="k">if</span> <span class="n">link_pattern</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">link_pattern</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.link_pattern must be a string&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">link_pattern</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.link_pattern cannot be empty&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Validate regex compiles</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">link_pattern</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">re</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid link_pattern regex: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Check version_pattern</span>
        <span class="k">if</span> <span class="s2">&quot;version_pattern&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Missing required field: source.version_pattern&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;version_pattern&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.version_pattern must be a string&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;version_pattern&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.version_pattern cannot be empty&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Validate regex compiles</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;version_pattern&quot;</span><span class="p">])</span>
            <span class="k">except</span> <span class="n">re</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid version_pattern regex: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Validate version_format if provided</span>
        <span class="k">if</span> <span class="s2">&quot;version_format&quot;</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;version_format&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.version_format must be a string&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;version_format&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.version_format cannot be empty&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">errors</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="notapkgtool.discovery.web_scrape.WebScrapeStrategy.get_version_info" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">get_version_info</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get_version_info</span><span class="p">(</span><span class="n">app_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">VersionInfo</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Scrape download page for version and URL without downloading (version-first path).</p>
<p>This method scrapes an HTML page, finds a download link using CSS selector
or regex, extracts the version from that link, and returns version info.
If the version matches cached state, the download can be skipped entirely.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>app_config</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>App configuration containing source.page_url,
source.link_selector or source.link_pattern, and
source.version_pattern.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>verbose</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, print verbose logging messages.
Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>debug</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, print debug logging messages.
Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="            VersionInfo


  
      dataclass
   (notapkgtool.versioning.keys.VersionInfo)" href="../versioning/#notapkgtool.versioning.keys.VersionInfo">VersionInfo</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Version info with version string, download URL, and
source name.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If required config fields are missing, invalid, or if
selectors/patterns don't match anything.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="RuntimeError">RuntimeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If page download fails (chained with 'from err').</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <p>Scrape 7-Zip download page:</p>
<pre><code>strategy = WebScrapeStrategy()
config = {
    "source": {
        "page_url": "https://www.7-zip.org/download.html",
        "link_selector": 'a[href$="-x64.msi"]',
        "version_pattern": "7z(\d{2})(\d{2})-x64",
        "version_format": "{0}.{1}"
    }
}
version_info = strategy.get_version_info(config)
# version_info.version returns: '25.01'
</code></pre>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>notapkgtool/discovery/web_scrape.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_version_info</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">app_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">VersionInfo</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Scrape download page for version and URL without downloading (version-first path).</span>

<span class="sd">    This method scrapes an HTML page, finds a download link using CSS selector</span>
<span class="sd">    or regex, extracts the version from that link, and returns version info.</span>
<span class="sd">    If the version matches cached state, the download can be skipped entirely.</span>

<span class="sd">    Args:</span>
<span class="sd">        app_config: App configuration containing source.page_url,</span>
<span class="sd">            source.link_selector or source.link_pattern, and</span>
<span class="sd">            source.version_pattern.</span>
<span class="sd">        verbose: If True, print verbose logging messages.</span>
<span class="sd">            Defaults to False.</span>
<span class="sd">        debug: If True, print debug logging messages.</span>
<span class="sd">            Defaults to False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Version info with version string, download URL, and</span>
<span class="sd">            source name.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If required config fields are missing, invalid, or if</span>
<span class="sd">            selectors/patterns don&#39;t match anything.</span>
<span class="sd">        RuntimeError: If page download fails (chained with &#39;from err&#39;).</span>

<span class="sd">    Example:</span>
<span class="sd">        Scrape 7-Zip download page:</span>

<span class="sd">            strategy = WebScrapeStrategy()</span>
<span class="sd">            config = {</span>
<span class="sd">                &quot;source&quot;: {</span>
<span class="sd">                    &quot;page_url&quot;: &quot;https://www.7-zip.org/download.html&quot;,</span>
<span class="sd">                    &quot;link_selector&quot;: &#39;a[href$=&quot;-x64.msi&quot;]&#39;,</span>
<span class="sd">                    &quot;version_pattern&quot;: &quot;7z(\\d{2})(\\d{2})-x64&quot;,</span>
<span class="sd">                    &quot;version_format&quot;: &quot;{0}.{1}&quot;</span>
<span class="sd">                }</span>
<span class="sd">            }</span>
<span class="sd">            version_info = strategy.get_version_info(config)</span>
<span class="sd">            # version_info.version returns: &#39;25.01&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">notapkgtool.cli</span><span class="w"> </span><span class="kn">import</span> <span class="n">print_verbose</span>

    <span class="c1"># Validate configuration</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">app_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">page_url</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;page_url&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">page_url</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;web_scrape strategy requires &#39;source.page_url&#39; in config&quot;</span><span class="p">)</span>

    <span class="n">link_selector</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;link_selector&quot;</span><span class="p">)</span>
    <span class="n">link_pattern</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;link_pattern&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">link_selector</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">link_pattern</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;web_scrape strategy requires either &#39;source.link_selector&#39; or &quot;</span>
            <span class="s2">&quot;&#39;source.link_pattern&#39; in config&quot;</span>
        <span class="p">)</span>

    <span class="n">version_pattern</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;version_pattern&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">version_pattern</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;web_scrape strategy requires &#39;source.version_pattern&#39; in config&quot;</span>
        <span class="p">)</span>

    <span class="n">version_format</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;version_format&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="s2">&quot;Strategy: web_scrape (version-first)&quot;</span><span class="p">)</span>
    <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Page URL: </span><span class="si">{</span><span class="n">page_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">link_selector</span><span class="p">:</span>
        <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Link selector (CSS): </span><span class="si">{</span><span class="n">link_selector</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">link_pattern</span><span class="p">:</span>
        <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Link pattern (regex): </span><span class="si">{</span><span class="n">link_pattern</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Version pattern: </span><span class="si">{</span><span class="n">version_pattern</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Download the HTML page</span>
    <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Fetching page: </span><span class="si">{</span><span class="n">page_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">page_url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Failed to fetch page: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to fetch page: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>

    <span class="n">html_content</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span>
    <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Page fetched (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">html_content</span><span class="p">)</span><span class="si">}</span><span class="s2"> bytes)&quot;</span><span class="p">)</span>

    <span class="c1"># Find download link using CSS selector or regex</span>
    <span class="n">download_url</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">link_selector</span><span class="p">:</span>
        <span class="c1"># Use CSS selector with BeautifulSoup4</span>
        <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">html_content</span><span class="p">,</span> <span class="s2">&quot;html.parser&quot;</span><span class="p">)</span>
        <span class="n">element</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">select_one</span><span class="p">(</span><span class="n">link_selector</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">element</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;CSS selector </span><span class="si">{</span><span class="n">link_selector</span><span class="si">!r}</span><span class="s2"> did not match any elements on page&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Get href attribute</span>
        <span class="n">href</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">href</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Element matched by </span><span class="si">{</span><span class="n">link_selector</span><span class="si">!r}</span><span class="s2"> has no href attribute&quot;</span>
            <span class="p">)</span>

        <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Found link via CSS: </span><span class="si">{</span><span class="n">href</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Build absolute URL</span>
        <span class="n">download_url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="n">page_url</span><span class="p">,</span> <span class="n">href</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">link_pattern</span><span class="p">:</span>
        <span class="c1"># Use regex fallback</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">link_pattern</span><span class="p">)</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">html_content</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Regex pattern </span><span class="si">{</span><span class="n">link_pattern</span><span class="si">!r}</span><span class="s2"> did not match anything on page&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Get first capture group or full match</span>
            <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">groups</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">href</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">href</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Found link via regex: </span><span class="si">{</span><span class="n">href</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Build absolute URL</span>
            <span class="n">download_url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="n">page_url</span><span class="p">,</span> <span class="n">href</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">re</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid link_pattern regex: </span><span class="si">{</span><span class="n">link_pattern</span><span class="si">!r}</span><span class="s2">&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>

    <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Download URL: </span><span class="si">{</span><span class="n">download_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Extract version from the download URL</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">version_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">version_pattern</span><span class="p">)</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">version_regex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">download_url</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Version pattern </span><span class="si">{</span><span class="n">version_pattern</span><span class="si">!r}</span><span class="s2"> did not match URL </span><span class="si">{</span><span class="n">download_url</span><span class="si">!r}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Get captured groups</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">groups</span><span class="p">:</span>
            <span class="c1"># No capture groups, use full match</span>
            <span class="n">version_str</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Format using captured groups</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">version_str</span> <span class="o">=</span> <span class="n">version_format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">groups</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;version_format </span><span class="si">{</span><span class="n">version_format</span><span class="si">!r}</span><span class="s2"> failed with groups </span><span class="si">{</span><span class="n">groups</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>

    <span class="k">except</span> <span class="n">re</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Invalid version_pattern regex: </span><span class="si">{</span><span class="n">version_pattern</span><span class="si">!r}</span><span class="s2">&quot;</span>
        <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>

    <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Extracted version: </span><span class="si">{</span><span class="n">version_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">VersionInfo</span><span class="p">(</span>
        <span class="n">version</span><span class="o">=</span><span class="n">version_str</span><span class="p">,</span>
        <span class="n">download_url</span><span class="o">=</span><span class="n">download_url</span><span class="p">,</span>
        <span class="n">source</span><span class="o">=</span><span class="s2">&quot;web_scrape&quot;</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="notapkgtool.discovery.web_scrape.WebScrapeStrategy.validate_config" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">validate_config</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">validate_config</span><span class="p">(</span><span class="n">app_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Validate web_scrape strategy configuration.</p>
<p>Checks for required fields and correct types without making network calls.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>app_config</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The app configuration from the recipe.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of error messages (empty if valid).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>notapkgtool/discovery/web_scrape.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">validate_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate web_scrape strategy configuration.</span>

<span class="sd">    Checks for required fields and correct types without making network calls.</span>

<span class="sd">    Args:</span>
<span class="sd">        app_config: The app configuration from the recipe.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of error messages (empty if valid).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">app_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="p">{})</span>

    <span class="c1"># Check page_url</span>
    <span class="k">if</span> <span class="s2">&quot;page_url&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Missing required field: source.page_url&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;page_url&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.page_url must be a string&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;page_url&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.page_url cannot be empty&quot;</span><span class="p">)</span>

    <span class="c1"># Check that at least one link finding method is provided</span>
    <span class="n">link_selector</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;link_selector&quot;</span><span class="p">)</span>
    <span class="n">link_pattern</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;link_pattern&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">link_selector</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">link_pattern</span><span class="p">:</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;Missing required field: must provide either source.link_selector or source.link_pattern&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Validate link_selector if provided</span>
    <span class="k">if</span> <span class="n">link_selector</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">link_selector</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.link_selector must be a string&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">link_selector</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.link_selector cannot be empty&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Try to validate CSS selector syntax</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Test if selector is parseable</span>
                <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="s2">&quot;&lt;html&gt;&lt;/html&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;html.parser&quot;</span><span class="p">)</span>
                <span class="n">soup</span><span class="o">.</span><span class="n">select_one</span><span class="p">(</span><span class="n">link_selector</span><span class="p">)</span>  <span class="c1"># Will raise if invalid</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid CSS selector: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Validate link_pattern if provided</span>
    <span class="k">if</span> <span class="n">link_pattern</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">link_pattern</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.link_pattern must be a string&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">link_pattern</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.link_pattern cannot be empty&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Validate regex compiles</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">link_pattern</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">re</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid link_pattern regex: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Check version_pattern</span>
    <span class="k">if</span> <span class="s2">&quot;version_pattern&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Missing required field: source.version_pattern&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;version_pattern&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.version_pattern must be a string&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;version_pattern&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.version_pattern cannot be empty&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Validate regex compiles</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;version_pattern&quot;</span><span class="p">])</span>
        <span class="k">except</span> <span class="n">re</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid version_pattern regex: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Validate version_format if provided</span>
    <span class="k">if</span> <span class="s2">&quot;version_format&quot;</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;version_format&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.version_format must be a string&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;version_format&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.version_format cannot be empty&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">errors</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="notapkgtool.discovery.api_github" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <span class="doc doc-object-name doc-module-name">notapkgtool.discovery.api_github</span>


</h2>

    <div class="doc doc-contents first">

        <p>GitHub API discovery strategy for NAPT.</p>
<p>This is a VERSION-FIRST strategy that queries the GitHub API to get version
and download URL WITHOUT downloading the installer. This enables fast version
checks and efficient caching.</p>
<p>Key Advantages:</p>
<ul>
<li>Fast version discovery (GitHub API call ~100ms)</li>
<li>Can skip downloads entirely when version unchanged</li>
<li>Direct access to latest releases via stable GitHub API</li>
<li>Version extraction from Git tags (semantic versioning friendly)</li>
<li>Asset pattern matching for multi-platform releases</li>
<li>Optional authentication for higher rate limits</li>
<li>No web scraping required</li>
<li>Ideal for CI/CD with scheduled checks</li>
</ul>
<p>Supported Version Extraction:</p>
<ul>
<li>Tag-based: Extract version from release tag names</li>
<li>Supports named capture groups: (?P<version>...)</li>
<li>Default pattern strips "v" prefix: v1.2.3 → 1.2.3</li>
<li>Falls back to full tag if no pattern match</li>
</ul>
<p>Use Cases:</p>
<ul>
<li>Open-source projects (Git, VS Code, Node.js, etc.)</li>
<li>Projects with GitHub releases (Firefox, Chrome alternatives)</li>
<li>Vendors who publish installers as release assets</li>
<li>Projects with semantic versioned tags</li>
<li>CI/CD pipelines with frequent version checks</li>
</ul>
<p>Recipe Configuration:</p>
<pre><code>source:
  strategy: api_github
  repo: "git-for-windows/git"                    # Required: owner/repo
  asset_pattern: "Git-.*-64-bit\.exe$"          # Required: regex for asset
  version_pattern: "v?([0-9.]+)"                 # Optional: version extraction
  prerelease: false                              # Optional: include prereleases
  token: "${GITHUB_TOKEN}"                       # Optional: auth token
</code></pre>
<p>Configuration Fields:</p>
<ul>
<li><strong>repo</strong> (str, required): GitHub repository in "owner/name" format (e.g., "git-for-windows/git")</li>
<li><strong>asset_pattern</strong> (str, required): Regular expression to match asset filename. If multiple assets match, the first match is used. Example: ".*-x64.msi$" matches assets ending with "-x64.msi"</li>
<li><strong>version_pattern</strong> (str, optional): Regular expression to extract version from the release tag name. Use a named capture group (?P<version>...) or the entire match. Default: "v?([0-9.]+)" strips optional "v" prefix. Example: "release-([0-9.]+)" for tags like "release-1.2.3"<ul>
<li><strong>prerelease</strong> (bool, optional): If True, include pre-release versions. If False
  (default), only stable releases are considered. Uses GitHub's prerelease flag.</li>
<li><strong>token</strong> (str, optional): GitHub personal access token for authentication.
  Increases rate limit from 60 to 5000 requests per hour. Can use environment
  variable substitution: "${GITHUB_TOKEN}". No special permissions needed for
  public repositories.</li>
</ul>
</li>
</ul>
<p>Error Handling:</p>
<ul>
<li>ValueError: Missing or invalid configuration fields</li>
<li>RuntimeError: API failures, no releases, no matching assets</li>
<li>Errors are chained with 'from err' for better debugging</li>
</ul>
<p>Rate Limits:</p>
<ul>
<li>Unauthenticated: 60 requests/hour per IP</li>
<li>Authenticated: 5000 requests/hour per token</li>
<li>Tip: Use a token for production use or frequent checks</li>
</ul>


<details class="example" open>
  <summary>Example</summary>
  <p>In a recipe YAML:</p>
<p>apps:
  - name: "Git for Windows"
    id: "git"
    source:
      strategy: api_github
      repo: "git-for-windows/git"
      asset_pattern: "Git-.*-64-bit.exe$"</p>
</details>        <p>From Python (version-first approach):</p>
<pre><code>from notapkgtool.discovery.api_github import ApiGithubStrategy
from notapkgtool.io import download_file

strategy = ApiGithubStrategy()
app_config = {
    "source": {
        "repo": "git-for-windows/git",
        "asset_pattern": ".*-64-bit\.exe$",
    }
}

# Get version WITHOUT downloading
version_info = strategy.get_version_info(app_config)
print(f"Latest version: {version_info.version}")

# Download only if needed
if need_to_download:
    file_path, sha256, headers = download_file(
        version_info.download_url, Path("./downloads")
    )
    print(f"Downloaded to {file_path}")
</code></pre>
<p>From Python (using core orchestration):</p>
<pre><code>from pathlib import Path
from notapkgtool.core import discover_recipe

# Automatically uses version-first optimization
result = discover_recipe(Path("recipe.yaml"), Path("./downloads"))
print(f"Version {result['version']} at {result['file_path']}")
</code></pre>


<details class="note" open>
  <summary>Note</summary>
  <p>Version discovery via API only (no download required).
Core orchestration automatically skips download if version unchanged.
The GitHub API is stable and well-documented. Releases are fetched in order
(latest first). Asset matching is case-sensitive by default (use (?i) for
case-insensitive). Consider url_download if you need a direct download URL instead.</p>
</details>









  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h3 id="notapkgtool.discovery.api_github.ApiGithubStrategy" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">ApiGithubStrategy</span>


</h3>


    <div class="doc doc-contents ">



        <p>Discovery strategy for GitHub releases.</p>


<details class="configuration-example" open>
  <summary>Configuration example</summary>
  <p>source:
  strategy: api_github
  repo: "owner/repository"
  asset_pattern: ".*.msi$"
  version_pattern: "v?([0-9.]+)"
  prerelease: false
  token: "${GITHUB_TOKEN}"</p>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>notapkgtool/discovery/api_github.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ApiGithubStrategy</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Discovery strategy for GitHub releases.</span>

<span class="sd">    Configuration example:</span>
<span class="sd">        source:</span>
<span class="sd">          strategy: api_github</span>
<span class="sd">          repo: &quot;owner/repository&quot;</span>
<span class="sd">          asset_pattern: &quot;.*\\.msi$&quot;</span>
<span class="sd">          version_pattern: &quot;v?([0-9.]+)&quot;</span>
<span class="sd">          prerelease: false</span>
<span class="sd">          token: &quot;${GITHUB_TOKEN}&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_version_info</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">app_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">VersionInfo</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fetch latest release from GitHub API without downloading (version-first path).</span>

<span class="sd">        This method queries the GitHub API for the latest release and extracts</span>
<span class="sd">        the version from the tag name and the download URL from matching assets.</span>
<span class="sd">        If the version matches cached state, the download can be skipped entirely.</span>

<span class="sd">        Args:</span>
<span class="sd">            app_config: App configuration containing source.repo and</span>
<span class="sd">                optional fields.</span>
<span class="sd">            verbose: If True, print verbose logging messages.</span>
<span class="sd">                Default is False.</span>
<span class="sd">            debug: If True, print debug logging messages.</span>
<span class="sd">                Default is False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Version info with version string, download URL, and</span>
<span class="sd">                source name.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If required config fields are missing, invalid, or if</span>
<span class="sd">                no matching assets are found.</span>
<span class="sd">            RuntimeError: If API call fails or release has no assets.</span>

<span class="sd">        Example:</span>
<span class="sd">            Get version from GitHub releases:</span>

<span class="sd">                strategy = ApiGithubStrategy()</span>
<span class="sd">                config = {</span>
<span class="sd">                    &quot;source&quot;: {</span>
<span class="sd">                        &quot;repo&quot;: &quot;owner/repo&quot;,</span>
<span class="sd">                        &quot;asset_pattern&quot;: &quot;.*\\.msi$&quot;</span>
<span class="sd">                    }</span>
<span class="sd">                }</span>
<span class="sd">                version_info = strategy.get_version_info(config)</span>
<span class="sd">                # version_info.version returns: &#39;1.0.0&#39;</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">notapkgtool.cli</span><span class="w"> </span><span class="kn">import</span> <span class="n">print_verbose</span>

        <span class="c1"># Validate configuration</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">app_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;repo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">repo</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;api_github strategy requires &#39;source.repo&#39; in config&quot;</span><span class="p">)</span>

        <span class="c1"># Validate repo format</span>
        <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">repo</span> <span class="ow">or</span> <span class="n">repo</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid repo format: </span><span class="si">{</span><span class="n">repo</span><span class="si">!r}</span><span class="s2">. Expected &#39;owner/repository&#39;&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Optional configuration</span>
        <span class="n">asset_pattern</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;asset_pattern&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">asset_pattern</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;api_github strategy requires &#39;source.asset_pattern&#39; in config&quot;</span>
            <span class="p">)</span>

        <span class="n">version_pattern</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;version_pattern&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;v?([0-9.]+)&quot;</span><span class="p">)</span>
        <span class="n">prerelease</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prerelease&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;token&quot;</span><span class="p">)</span>

        <span class="c1"># Expand environment variables in token (e.g., ${GITHUB_TOKEN})</span>
        <span class="k">if</span> <span class="n">token</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;${&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">token</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;}&quot;</span><span class="p">):</span>
                <span class="n">env_var</span> <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">token</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">env_var</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
                    <span class="n">print_verbose</span><span class="p">(</span>
                        <span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s2">&quot;Warning: Environment variable </span><span class="si">{</span><span class="n">env_var</span><span class="si">}</span><span class="s2"> not set&quot;</span><span class="p">,</span>
                    <span class="p">)</span>

        <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="s2">&quot;Strategy: api_github (version-first)&quot;</span><span class="p">)</span>
        <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Repository: </span><span class="si">{</span><span class="n">repo</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Version pattern: </span><span class="si">{</span><span class="n">version_pattern</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">asset_pattern</span><span class="p">:</span>
            <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Asset pattern: </span><span class="si">{</span><span class="n">asset_pattern</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prerelease</span><span class="p">:</span>
            <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="s2">&quot;Including pre-releases&quot;</span><span class="p">)</span>

        <span class="c1"># Fetch latest release from GitHub API</span>
        <span class="n">api_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://api.github.com/repos/</span><span class="si">{</span><span class="n">repo</span><span class="si">}</span><span class="s2">/releases/latest&quot;</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;application/vnd.github+json&quot;</span><span class="p">,</span>
            <span class="s2">&quot;X-GitHub-Api-Version&quot;</span><span class="p">:</span> <span class="s2">&quot;2022-11-28&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Add authentication if token provided</span>
        <span class="k">if</span> <span class="n">token</span><span class="p">:</span>
            <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Authorization&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="s2">&quot;Using authenticated API request&quot;</span><span class="p">)</span>

        <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Fetching release from: </span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
            <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Repository </span><span class="si">{</span><span class="n">repo</span><span class="si">!r}</span><span class="s2"> not found or has no releases&quot;</span>
                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>
            <span class="k">elif</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">403</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;GitHub API rate limit exceeded. Consider using a token. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Status: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;GitHub API request failed: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to fetch GitHub release: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>

        <span class="n">release_data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

        <span class="c1"># Check if this is a prerelease and we don&#39;t want those</span>
        <span class="k">if</span> <span class="n">release_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prerelease&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">prerelease</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Latest release is a pre-release and prerelease=false. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Tag: </span><span class="si">{</span><span class="n">release_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tag_name&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Extract version from tag name</span>
        <span class="n">tag_name</span> <span class="o">=</span> <span class="n">release_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tag_name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tag_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Release has no tag_name field&quot;</span><span class="p">)</span>

        <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Release tag: </span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">version_pattern</span><span class="p">)</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">tag_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Version pattern </span><span class="si">{</span><span class="n">version_pattern</span><span class="si">!r}</span><span class="s2"> did not match tag </span><span class="si">{</span><span class="n">tag_name</span><span class="si">!r}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Try to get named capture group &#39;version&#39; first, else use group 1, else full match</span>
            <span class="k">if</span> <span class="s2">&quot;version&quot;</span> <span class="ow">in</span> <span class="n">pattern</span><span class="o">.</span><span class="n">groupindex</span><span class="p">:</span>
                <span class="n">version_str</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;version&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">pattern</span><span class="o">.</span><span class="n">groups</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">version_str</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">version_str</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">re</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid version_pattern regex: </span><span class="si">{</span><span class="n">version_pattern</span><span class="si">!r}</span><span class="s2">&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">)</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to extract version from tag </span><span class="si">{</span><span class="n">tag_name</span><span class="si">!r}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;using pattern </span><span class="si">{</span><span class="n">version_pattern</span><span class="si">!r}</span><span class="s2">: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>

        <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Extracted version: </span><span class="si">{</span><span class="n">version_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Find matching asset</span>
        <span class="n">assets</span> <span class="o">=</span> <span class="n">release_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;assets&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">assets</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Release </span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s2"> has no assets. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Check if assets were uploaded to the release.&quot;</span>
            <span class="p">)</span>

        <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Release has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">assets</span><span class="p">)</span><span class="si">}</span><span class="s2"> asset(s)&quot;</span><span class="p">)</span>

        <span class="c1"># Match asset by pattern</span>
        <span class="n">matched_asset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">asset_pattern</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">re</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid asset_pattern regex: </span><span class="si">{</span><span class="n">asset_pattern</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>

        <span class="k">for</span> <span class="n">asset</span> <span class="ow">in</span> <span class="n">assets</span><span class="p">:</span>
            <span class="n">asset_name</span> <span class="o">=</span> <span class="n">asset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">asset_name</span><span class="p">):</span>
                <span class="n">matched_asset</span> <span class="o">=</span> <span class="n">asset</span>
                <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Matched asset: </span><span class="si">{</span><span class="n">asset_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">matched_asset</span><span class="p">:</span>
            <span class="n">available</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;(unnamed)&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">assets</span><span class="p">]</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No assets matched pattern </span><span class="si">{</span><span class="n">asset_pattern</span><span class="si">!r}</span><span class="s2">. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Available assets: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">available</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Get download URL</span>
        <span class="n">download_url</span> <span class="o">=</span> <span class="n">matched_asset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browser_download_url&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">download_url</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Asset </span><span class="si">{</span><span class="n">matched_asset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> has no download URL&quot;</span><span class="p">)</span>

        <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Download URL: </span><span class="si">{</span><span class="n">download_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">VersionInfo</span><span class="p">(</span>
            <span class="n">version</span><span class="o">=</span><span class="n">version_str</span><span class="p">,</span>
            <span class="n">download_url</span><span class="o">=</span><span class="n">download_url</span><span class="p">,</span>
            <span class="n">source</span><span class="o">=</span><span class="s2">&quot;api_github&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate api_github strategy configuration.</span>

<span class="sd">        Checks for required fields and correct types without making network calls.</span>

<span class="sd">        Args:</span>
<span class="sd">            app_config: The app configuration from the recipe.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of error messages (empty if valid).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">app_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="c1"># Check required fields</span>
        <span class="k">if</span> <span class="s2">&quot;repo&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Missing required field: source.repo&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;repo&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.repo must be a string&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;repo&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.repo cannot be empty&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Validate repo format</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;repo&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">repo</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s2">&quot;source.repo must be in format &#39;owner/repo&#39; (e.g., &#39;git/git&#39;)&quot;</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;asset_pattern&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Missing required field: source.asset_pattern&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;asset_pattern&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.asset_pattern must be a string&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;asset_pattern&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.asset_pattern cannot be empty&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Validate regex pattern syntax</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;asset_pattern&quot;</span><span class="p">]</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">re</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid asset_pattern regex: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Optional fields validation</span>
        <span class="k">if</span> <span class="s2">&quot;version_pattern&quot;</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;version_pattern&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.version_pattern must be a string&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;version_pattern&quot;</span><span class="p">]</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">re</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid version_pattern regex: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">errors</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="notapkgtool.discovery.api_github.ApiGithubStrategy.get_version_info" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">get_version_info</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get_version_info</span><span class="p">(</span><span class="n">app_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">VersionInfo</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Fetch latest release from GitHub API without downloading (version-first path).</p>
<p>This method queries the GitHub API for the latest release and extracts
the version from the tag name and the download URL from matching assets.
If the version matches cached state, the download can be skipped entirely.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>app_config</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>App configuration containing source.repo and
optional fields.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>verbose</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, print verbose logging messages.
Default is False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>debug</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, print debug logging messages.
Default is False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="            VersionInfo


  
      dataclass
   (notapkgtool.versioning.keys.VersionInfo)" href="../versioning/#notapkgtool.versioning.keys.VersionInfo">VersionInfo</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Version info with version string, download URL, and
source name.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If required config fields are missing, invalid, or if
no matching assets are found.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="RuntimeError">RuntimeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If API call fails or release has no assets.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <p>Get version from GitHub releases:</p>
<pre><code>strategy = ApiGithubStrategy()
config = {
    "source": {
        "repo": "owner/repo",
        "asset_pattern": ".*\.msi$"
    }
}
version_info = strategy.get_version_info(config)
# version_info.version returns: '1.0.0'
</code></pre>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>notapkgtool/discovery/api_github.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_version_info</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">app_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">VersionInfo</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fetch latest release from GitHub API without downloading (version-first path).</span>

<span class="sd">    This method queries the GitHub API for the latest release and extracts</span>
<span class="sd">    the version from the tag name and the download URL from matching assets.</span>
<span class="sd">    If the version matches cached state, the download can be skipped entirely.</span>

<span class="sd">    Args:</span>
<span class="sd">        app_config: App configuration containing source.repo and</span>
<span class="sd">            optional fields.</span>
<span class="sd">        verbose: If True, print verbose logging messages.</span>
<span class="sd">            Default is False.</span>
<span class="sd">        debug: If True, print debug logging messages.</span>
<span class="sd">            Default is False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Version info with version string, download URL, and</span>
<span class="sd">            source name.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If required config fields are missing, invalid, or if</span>
<span class="sd">            no matching assets are found.</span>
<span class="sd">        RuntimeError: If API call fails or release has no assets.</span>

<span class="sd">    Example:</span>
<span class="sd">        Get version from GitHub releases:</span>

<span class="sd">            strategy = ApiGithubStrategy()</span>
<span class="sd">            config = {</span>
<span class="sd">                &quot;source&quot;: {</span>
<span class="sd">                    &quot;repo&quot;: &quot;owner/repo&quot;,</span>
<span class="sd">                    &quot;asset_pattern&quot;: &quot;.*\\.msi$&quot;</span>
<span class="sd">                }</span>
<span class="sd">            }</span>
<span class="sd">            version_info = strategy.get_version_info(config)</span>
<span class="sd">            # version_info.version returns: &#39;1.0.0&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">notapkgtool.cli</span><span class="w"> </span><span class="kn">import</span> <span class="n">print_verbose</span>

    <span class="c1"># Validate configuration</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">app_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;repo&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">repo</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;api_github strategy requires &#39;source.repo&#39; in config&quot;</span><span class="p">)</span>

    <span class="c1"># Validate repo format</span>
    <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">repo</span> <span class="ow">or</span> <span class="n">repo</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Invalid repo format: </span><span class="si">{</span><span class="n">repo</span><span class="si">!r}</span><span class="s2">. Expected &#39;owner/repository&#39;&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Optional configuration</span>
    <span class="n">asset_pattern</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;asset_pattern&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">asset_pattern</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;api_github strategy requires &#39;source.asset_pattern&#39; in config&quot;</span>
        <span class="p">)</span>

    <span class="n">version_pattern</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;version_pattern&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;v?([0-9.]+)&quot;</span><span class="p">)</span>
    <span class="n">prerelease</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prerelease&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;token&quot;</span><span class="p">)</span>

    <span class="c1"># Expand environment variables in token (e.g., ${GITHUB_TOKEN})</span>
    <span class="k">if</span> <span class="n">token</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;${&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">token</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;}&quot;</span><span class="p">):</span>
            <span class="n">env_var</span> <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">token</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">env_var</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
                <span class="n">print_verbose</span><span class="p">(</span>
                    <span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;Warning: Environment variable </span><span class="si">{</span><span class="n">env_var</span><span class="si">}</span><span class="s2"> not set&quot;</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="s2">&quot;Strategy: api_github (version-first)&quot;</span><span class="p">)</span>
    <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Repository: </span><span class="si">{</span><span class="n">repo</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Version pattern: </span><span class="si">{</span><span class="n">version_pattern</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">asset_pattern</span><span class="p">:</span>
        <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Asset pattern: </span><span class="si">{</span><span class="n">asset_pattern</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">prerelease</span><span class="p">:</span>
        <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="s2">&quot;Including pre-releases&quot;</span><span class="p">)</span>

    <span class="c1"># Fetch latest release from GitHub API</span>
    <span class="n">api_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://api.github.com/repos/</span><span class="si">{</span><span class="n">repo</span><span class="si">}</span><span class="s2">/releases/latest&quot;</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;application/vnd.github+json&quot;</span><span class="p">,</span>
        <span class="s2">&quot;X-GitHub-Api-Version&quot;</span><span class="p">:</span> <span class="s2">&quot;2022-11-28&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># Add authentication if token provided</span>
    <span class="k">if</span> <span class="n">token</span><span class="p">:</span>
        <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Authorization&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="s2">&quot;Using authenticated API request&quot;</span><span class="p">)</span>

    <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Fetching release from: </span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Repository </span><span class="si">{</span><span class="n">repo</span><span class="si">!r}</span><span class="s2"> not found or has no releases&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>
        <span class="k">elif</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">403</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;GitHub API rate limit exceeded. Consider using a token. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Status: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;GitHub API request failed: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to fetch GitHub release: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>

    <span class="n">release_data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

    <span class="c1"># Check if this is a prerelease and we don&#39;t want those</span>
    <span class="k">if</span> <span class="n">release_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prerelease&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">prerelease</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Latest release is a pre-release and prerelease=false. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Tag: </span><span class="si">{</span><span class="n">release_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tag_name&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Extract version from tag name</span>
    <span class="n">tag_name</span> <span class="o">=</span> <span class="n">release_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tag_name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">tag_name</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Release has no tag_name field&quot;</span><span class="p">)</span>

    <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Release tag: </span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">version_pattern</span><span class="p">)</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">tag_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Version pattern </span><span class="si">{</span><span class="n">version_pattern</span><span class="si">!r}</span><span class="s2"> did not match tag </span><span class="si">{</span><span class="n">tag_name</span><span class="si">!r}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Try to get named capture group &#39;version&#39; first, else use group 1, else full match</span>
        <span class="k">if</span> <span class="s2">&quot;version&quot;</span> <span class="ow">in</span> <span class="n">pattern</span><span class="o">.</span><span class="n">groupindex</span><span class="p">:</span>
            <span class="n">version_str</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;version&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">pattern</span><span class="o">.</span><span class="n">groups</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">version_str</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">version_str</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">re</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Invalid version_pattern regex: </span><span class="si">{</span><span class="n">version_pattern</span><span class="si">!r}</span><span class="s2">&quot;</span>
        <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">)</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Failed to extract version from tag </span><span class="si">{</span><span class="n">tag_name</span><span class="si">!r}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;using pattern </span><span class="si">{</span><span class="n">version_pattern</span><span class="si">!r}</span><span class="s2">: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>

    <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Extracted version: </span><span class="si">{</span><span class="n">version_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Find matching asset</span>
    <span class="n">assets</span> <span class="o">=</span> <span class="n">release_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;assets&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">assets</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Release </span><span class="si">{</span><span class="n">tag_name</span><span class="si">}</span><span class="s2"> has no assets. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Check if assets were uploaded to the release.&quot;</span>
        <span class="p">)</span>

    <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Release has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">assets</span><span class="p">)</span><span class="si">}</span><span class="s2"> asset(s)&quot;</span><span class="p">)</span>

    <span class="c1"># Match asset by pattern</span>
    <span class="n">matched_asset</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">asset_pattern</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">re</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid asset_pattern regex: </span><span class="si">{</span><span class="n">asset_pattern</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>

    <span class="k">for</span> <span class="n">asset</span> <span class="ow">in</span> <span class="n">assets</span><span class="p">:</span>
        <span class="n">asset_name</span> <span class="o">=</span> <span class="n">asset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">asset_name</span><span class="p">):</span>
            <span class="n">matched_asset</span> <span class="o">=</span> <span class="n">asset</span>
            <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Matched asset: </span><span class="si">{</span><span class="n">asset_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">matched_asset</span><span class="p">:</span>
        <span class="n">available</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;(unnamed)&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">assets</span><span class="p">]</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;No assets matched pattern </span><span class="si">{</span><span class="n">asset_pattern</span><span class="si">!r}</span><span class="s2">. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Available assets: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">available</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Get download URL</span>
    <span class="n">download_url</span> <span class="o">=</span> <span class="n">matched_asset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;browser_download_url&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">download_url</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Asset </span><span class="si">{</span><span class="n">matched_asset</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> has no download URL&quot;</span><span class="p">)</span>

    <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Download URL: </span><span class="si">{</span><span class="n">download_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">VersionInfo</span><span class="p">(</span>
        <span class="n">version</span><span class="o">=</span><span class="n">version_str</span><span class="p">,</span>
        <span class="n">download_url</span><span class="o">=</span><span class="n">download_url</span><span class="p">,</span>
        <span class="n">source</span><span class="o">=</span><span class="s2">&quot;api_github&quot;</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="notapkgtool.discovery.api_github.ApiGithubStrategy.validate_config" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">validate_config</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">validate_config</span><span class="p">(</span><span class="n">app_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Validate api_github strategy configuration.</p>
<p>Checks for required fields and correct types without making network calls.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>app_config</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The app configuration from the recipe.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of error messages (empty if valid).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>notapkgtool/discovery/api_github.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">validate_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate api_github strategy configuration.</span>

<span class="sd">    Checks for required fields and correct types without making network calls.</span>

<span class="sd">    Args:</span>
<span class="sd">        app_config: The app configuration from the recipe.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of error messages (empty if valid).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">app_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="p">{})</span>

    <span class="c1"># Check required fields</span>
    <span class="k">if</span> <span class="s2">&quot;repo&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Missing required field: source.repo&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;repo&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.repo must be a string&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;repo&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.repo cannot be empty&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Validate repo format</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;repo&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">repo</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;source.repo must be in format &#39;owner/repo&#39; (e.g., &#39;git/git&#39;)&quot;</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;asset_pattern&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Missing required field: source.asset_pattern&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;asset_pattern&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.asset_pattern must be a string&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;asset_pattern&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.asset_pattern cannot be empty&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Validate regex pattern syntax</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;asset_pattern&quot;</span><span class="p">]</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">re</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid asset_pattern regex: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Optional fields validation</span>
    <span class="k">if</span> <span class="s2">&quot;version_pattern&quot;</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;version_pattern&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.version_pattern must be a string&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;version_pattern&quot;</span><span class="p">]</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">re</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid version_pattern regex: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">errors</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="notapkgtool.discovery.api_json" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <span class="doc doc-object-name doc-module-name">notapkgtool.discovery.api_json</span>


</h2>

    <div class="doc doc-contents first">

        <p>JSON API discovery strategy for NAPT.</p>
<p>This is a VERSION-FIRST strategy that queries JSON API endpoints to get version
and download URL WITHOUT downloading the installer. This enables fast version
checks and efficient caching.</p>
<p>Key Advantages:</p>
<ul>
<li>Fast version discovery (API call ~100ms)</li>
<li>Can skip downloads entirely when version unchanged</li>
<li>Direct API access for version and download URL</li>
<li>Support for complex JSON structures with JSONPath</li>
<li>Custom headers for authentication</li>
<li>Support for GET and POST requests</li>
<li>No file parsing required</li>
<li>Ideal for CI/CD with scheduled checks</li>
</ul>
<p>Supported Features:</p>
<ul>
<li>JSONPath navigation for nested structures</li>
<li>Array indexing and filtering</li>
<li>Custom HTTP headers (Authorization, etc.)</li>
<li>POST requests with JSON body</li>
<li>Environment variable expansion in values</li>
</ul>
<p>Use Cases:</p>
<ul>
<li>Vendors with JSON APIs (Microsoft, Mozilla, etc.)</li>
<li>Cloud services with version endpoints</li>
<li>CDNs that provide metadata APIs</li>
<li>Applications with update check APIs</li>
<li>APIs requiring authentication or custom headers</li>
<li>CI/CD pipelines with frequent version checks</li>
</ul>
<p>Recipe Configuration:</p>
<pre><code>source:
  strategy: api_json
  api_url: "https://vendor.com/api/latest"
  version_path: "version"                      # JSONPath to version
  download_url_path: "download_url"            # JSONPath to URL
  method: "GET"                                # Optional: GET or POST
  headers:                                     # Optional: custom headers
    Authorization: "Bearer ${API_TOKEN}"
    Accept: "application/json"
  body:                                        # Optional: POST body
    platform: "windows"
    arch: "x64"
  timeout: 30                                  # Optional: timeout in seconds
</code></pre>
<p>Configuration Fields:</p>
<ul>
<li><strong>api_url</strong> (str, required): API endpoint URL that returns JSON with version and download information</li>
<li><strong>version_path</strong> (str, required): JSONPath expression to extract version from the API response. Examples: "version", "release.version", "data.version"</li>
<li><strong>download_url_path</strong> (str, required): JSONPath expression to extract download URL from the API response. Examples: "download_url", "assets.url", "platforms.windows.x64"</li>
<li><strong>method</strong> (str, optional): HTTP method to use. Either "GET" or "POST". Default is "GET"</li>
<li><strong>headers</strong> (dict, optional): Custom HTTP headers to send with the request. Useful for authentication or setting Accept headers. Values support environment variable expansion. Example: {"Authorization": "Bearer ${API_TOKEN}"}</li>
<li><strong>body</strong> (dict, optional): Request body for POST requests. Sent as JSON. Only used when method="POST". Example: {"platform": "windows", "arch": "x64"}<ul>
<li><strong>timeout</strong> (int, optional): Request timeout in seconds. Default is 30.</li>
</ul>
</li>
</ul>
<p>JSONPath Syntax:</p>
<ul>
<li>Simple paths: "version", "release.version"</li>
<li>Array indexing: "data.version", "releases.version"</li>
<li>Nested paths: "data.latest.download.url", "response.assets.browser_download_url"</li>
</ul>
<p>Error Handling:</p>
<ul>
<li>ValueError: Missing or invalid configuration, invalid JSONPath, path not found</li>
<li>RuntimeError: API failures, invalid JSON response</li>
<li>Errors are chained with 'from err' for better debugging</li>
</ul>
<p>Example:
In a recipe YAML (simple API):</p>
<pre><code>apps:
  - name: "My App"
    id: "my-app"
    source:
      strategy: api_json
      api_url: "https://api.vendor.com/latest"
      version_path: "version"
      download_url_path: "download_url"
</code></pre>
<p>In a recipe YAML (nested structure):</p>
<pre><code>apps:
  - name: "My App"
    id: "my-app"
    source:
      strategy: api_json
      api_url: "https://api.vendor.com/releases"
      version_path: "stable.version"
      download_url_path: "stable.platforms.windows.x64"
      headers:
        Authorization: "Bearer ${API_TOKEN}"
</code></pre>
<p>From Python (version-first approach):</p>
<pre><code>from notapkgtool.discovery.api_json import ApiJsonStrategy
from notapkgtool.io import download_file

strategy = ApiJsonStrategy()
app_config = {
    "source": {
        "api_url": "https://api.vendor.com/latest",
        "version_path": "version",
        "download_url_path": "download_url",
    }
}

# Get version WITHOUT downloading
version_info = strategy.get_version_info(app_config)
print(f"Latest version: {version_info.version}")

# Download only if needed
if need_to_download:
    file_path, sha256, headers = download_file(
        version_info.download_url, Path("./downloads")
    )
    print(f"Downloaded to {file_path}")
</code></pre>
<p>From Python (using core orchestration):</p>
<pre><code>from pathlib import Path
from notapkgtool.core import discover_recipe

# Automatically uses version-first optimization
result = discover_recipe(Path("recipe.yaml"), Path("./downloads"))
print(f"Version {result['version']} at {result['file_path']}")
</code></pre>


<details class="note" open>
  <summary>Note</summary>
  <ul>
<li>Version discovery via API only (no download required)</li>
<li>Core orchestration automatically skips download if version unchanged</li>
<li>JSONPath uses jsonpath-ng library for robust parsing</li>
<li>Environment variable expansion works in headers and other string values</li>
<li>POST body is sent as JSON (Content-Type: application/json)</li>
<li>Timeout defaults to 30 seconds to prevent hanging on slow APIs</li>
</ul>
</details>









  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h3 id="notapkgtool.discovery.api_json.ApiJsonStrategy" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <span class="doc doc-object-name doc-class-name">ApiJsonStrategy</span>


</h3>


    <div class="doc doc-contents ">



        <p>Discovery strategy for JSON API endpoints.</p>


<details class="configuration-example" open>
  <summary>Configuration example</summary>
  <p>source:
  strategy: api_json
  api_url: "https://api.vendor.com/latest"
  version_path: "version"
  download_url_path: "download_url"
  method: "GET"
  headers:
    Authorization: "Bearer ${API_TOKEN}"</p>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>notapkgtool/discovery/api_json.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ApiJsonStrategy</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Discovery strategy for JSON API endpoints.</span>

<span class="sd">    Configuration example:</span>
<span class="sd">        source:</span>
<span class="sd">          strategy: api_json</span>
<span class="sd">          api_url: &quot;https://api.vendor.com/latest&quot;</span>
<span class="sd">          version_path: &quot;version&quot;</span>
<span class="sd">          download_url_path: &quot;download_url&quot;</span>
<span class="sd">          method: &quot;GET&quot;</span>
<span class="sd">          headers:</span>
<span class="sd">            Authorization: &quot;Bearer ${API_TOKEN}&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_version_info</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">app_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">VersionInfo</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Query JSON API for version and download URL without downloading (version-first path).</span>

<span class="sd">        This method calls a JSON API, extracts version and download URL using</span>
<span class="sd">        JSONPath expressions. If the version matches cached state, the download</span>
<span class="sd">        can be skipped entirely.</span>

<span class="sd">        Args:</span>
<span class="sd">            app_config: App configuration containing source.api_url,</span>
<span class="sd">                source.version_path, and source.download_url_path.</span>
<span class="sd">            verbose: If True, print verbose logging messages.</span>
<span class="sd">                Default is False.</span>
<span class="sd">            debug: If True, print debug logging messages.</span>
<span class="sd">                Default is False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Version info with version string, download URL, and</span>
<span class="sd">                source name.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If required config fields are missing, invalid, or if</span>
<span class="sd">                JSONPath expressions don&#39;t match anything in the response.</span>
<span class="sd">            RuntimeError: If API call fails (chained with &#39;from err&#39;).</span>

<span class="sd">        Example:</span>
<span class="sd">            Get version info from JSON API:</span>

<span class="sd">                strategy = ApiJsonStrategy()</span>
<span class="sd">                config = {</span>
<span class="sd">                    &quot;source&quot;: {</span>
<span class="sd">                        &quot;api_url&quot;: &quot;https://api.vendor.com/latest&quot;,</span>
<span class="sd">                        &quot;version_path&quot;: &quot;version&quot;,</span>
<span class="sd">                        &quot;download_url_path&quot;: &quot;download_url&quot;</span>
<span class="sd">                    }</span>
<span class="sd">                }</span>
<span class="sd">                version_info = strategy.get_version_info(config)</span>
<span class="sd">                # version_info.version returns: &#39;1.0.0&#39;</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">notapkgtool.cli</span><span class="w"> </span><span class="kn">import</span> <span class="n">print_verbose</span>

        <span class="c1"># Validate configuration</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">app_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">api_url</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;api_url&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">api_url</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;api_json strategy requires &#39;source.api_url&#39; in config&quot;</span><span class="p">)</span>

        <span class="n">version_path</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;version_path&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">version_path</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;api_json strategy requires &#39;source.version_path&#39; in config&quot;</span>
            <span class="p">)</span>

        <span class="n">download_url_path</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;download_url_path&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">download_url_path</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;api_json strategy requires &#39;source.download_url_path&#39; in config&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Optional configuration</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;method&quot;</span><span class="p">,</span> <span class="s2">&quot;GET&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid method: </span><span class="si">{</span><span class="n">method</span><span class="si">!r}</span><span class="s2">. Must be &#39;GET&#39; or &#39;POST&#39;&quot;</span><span class="p">)</span>

        <span class="n">headers</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;headers&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timeout&quot;</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>

        <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="s2">&quot;Strategy: api_json (version-first)&quot;</span><span class="p">)</span>
        <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;API URL: </span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Method: </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Version path: </span><span class="si">{</span><span class="n">version_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Download URL path: </span><span class="si">{</span><span class="n">download_url_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Expand environment variables in headers</span>
        <span class="n">expanded_headers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">headers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;${&quot;</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;}&quot;</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">env_var</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">env_value</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">env_var</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">env_value</span><span class="p">:</span>
                    <span class="n">print_verbose</span><span class="p">(</span>
                        <span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s2">&quot;Warning: Environment variable </span><span class="si">{</span><span class="n">env_var</span><span class="si">}</span><span class="s2"> not set&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">expanded_headers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">env_value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">expanded_headers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="c1"># Make API request</span>
        <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Calling API: </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">api_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">expanded_headers</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># POST</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                    <span class="n">api_url</span><span class="p">,</span>
                    <span class="n">headers</span><span class="o">=</span><span class="n">expanded_headers</span><span class="p">,</span>
                    <span class="n">json</span><span class="o">=</span><span class="n">body</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;API request failed: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to call API: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>

        <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;API response: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> OK&quot;</span><span class="p">)</span>

        <span class="c1"># Parse JSON response</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">json_data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid JSON response from API. Response: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">print_verbose</span><span class="p">(</span>
                <span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;JSON response: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">json_data</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Extract version using JSONPath</span>
        <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Extracting version from path: </span><span class="si">{</span><span class="n">version_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">version_expr</span> <span class="o">=</span> <span class="n">jsonpath_parse</span><span class="p">(</span><span class="n">version_path</span><span class="p">)</span>
            <span class="n">version_matches</span> <span class="o">=</span> <span class="n">version_expr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">json_data</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">version_matches</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Version path </span><span class="si">{</span><span class="n">version_path</span><span class="si">!r}</span><span class="s2"> did not match anything in API response&quot;</span>
                <span class="p">)</span>

            <span class="n">version_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">version_matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                <span class="k">raise</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to extract version using path </span><span class="si">{</span><span class="n">version_path</span><span class="si">!r}</span><span class="s2">: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>

        <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Extracted version: </span><span class="si">{</span><span class="n">version_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Extract download URL using JSONPath</span>
        <span class="n">print_verbose</span><span class="p">(</span>
            <span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Extracting download URL from path: </span><span class="si">{</span><span class="n">download_url_path</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">url_expr</span> <span class="o">=</span> <span class="n">jsonpath_parse</span><span class="p">(</span><span class="n">download_url_path</span><span class="p">)</span>
            <span class="n">url_matches</span> <span class="o">=</span> <span class="n">url_expr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">json_data</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">url_matches</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Download URL path </span><span class="si">{</span><span class="n">download_url_path</span><span class="si">!r}</span><span class="s2"> did not match anything in API response&quot;</span>
                <span class="p">)</span>

            <span class="n">download_url</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">url_matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                <span class="k">raise</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to extract download URL using path </span><span class="si">{</span><span class="n">download_url_path</span><span class="si">!r}</span><span class="s2">: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>

        <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Download URL: </span><span class="si">{</span><span class="n">download_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">VersionInfo</span><span class="p">(</span>
            <span class="n">version</span><span class="o">=</span><span class="n">version_str</span><span class="p">,</span>
            <span class="n">download_url</span><span class="o">=</span><span class="n">download_url</span><span class="p">,</span>
            <span class="n">source</span><span class="o">=</span><span class="s2">&quot;api_json&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate api_json strategy configuration.</span>

<span class="sd">        Checks for required fields and correct types without making network calls.</span>

<span class="sd">        Args:</span>
<span class="sd">            app_config: The app configuration from the recipe.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of error messages (empty if valid).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">app_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="c1"># Check required fields</span>
        <span class="k">if</span> <span class="s2">&quot;api_url&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Missing required field: source.api_url&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;api_url&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.api_url must be a string&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;api_url&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.api_url cannot be empty&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;version_path&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Missing required field: source.version_path&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;version_path&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.version_path must be a string&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;version_path&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.version_path cannot be empty&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Validate JSONPath syntax</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">jsonpath_ng</span><span class="w"> </span><span class="kn">import</span> <span class="n">parse</span> <span class="k">as</span> <span class="n">jsonpath_parse</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">jsonpath_parse</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;version_path&quot;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid version_path JSONPath: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;download_url_path&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Missing required field: source.download_url_path&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;download_url_path&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.download_url_path must be a string&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;download_url_path&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.download_url_path cannot be empty&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Validate JSONPath syntax</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">jsonpath_ng</span><span class="w"> </span><span class="kn">import</span> <span class="n">parse</span> <span class="k">as</span> <span class="n">jsonpath_parse</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">jsonpath_parse</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;download_url_path&quot;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid download_url_path JSONPath: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Optional fields validation</span>
        <span class="k">if</span> <span class="s2">&quot;method&quot;</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
            <span class="n">method</span> <span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.method must be a string&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">]:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.method must be &#39;GET&#39; or &#39;POST&#39;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;headers&quot;</span> <span class="ow">in</span> <span class="n">source</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;headers&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.headers must be a dictionary&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;body&quot;</span> <span class="ow">in</span> <span class="n">source</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;body&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.body must be a dictionary&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">errors</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="notapkgtool.discovery.api_json.ApiJsonStrategy.get_version_info" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">get_version_info</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">get_version_info</span><span class="p">(</span><span class="n">app_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">VersionInfo</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Query JSON API for version and download URL without downloading (version-first path).</p>
<p>This method calls a JSON API, extracts version and download URL using
JSONPath expressions. If the version matches cached state, the download
can be skipped entirely.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>app_config</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>App configuration containing source.api_url,
source.version_path, and source.download_url_path.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>verbose</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, print verbose logging messages.
Default is False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>debug</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, print debug logging messages.
Default is False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="            VersionInfo


  
      dataclass
   (notapkgtool.versioning.keys.VersionInfo)" href="../versioning/#notapkgtool.versioning.keys.VersionInfo">VersionInfo</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Version info with version string, download URL, and
source name.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If required config fields are missing, invalid, or if
JSONPath expressions don't match anything in the response.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="RuntimeError">RuntimeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If API call fails (chained with 'from err').</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <p>Get version info from JSON API:</p>
<pre><code>strategy = ApiJsonStrategy()
config = {
    "source": {
        "api_url": "https://api.vendor.com/latest",
        "version_path": "version",
        "download_url_path": "download_url"
    }
}
version_info = strategy.get_version_info(config)
# version_info.version returns: '1.0.0'
</code></pre>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>notapkgtool/discovery/api_json.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_version_info</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">app_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">VersionInfo</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Query JSON API for version and download URL without downloading (version-first path).</span>

<span class="sd">    This method calls a JSON API, extracts version and download URL using</span>
<span class="sd">    JSONPath expressions. If the version matches cached state, the download</span>
<span class="sd">    can be skipped entirely.</span>

<span class="sd">    Args:</span>
<span class="sd">        app_config: App configuration containing source.api_url,</span>
<span class="sd">            source.version_path, and source.download_url_path.</span>
<span class="sd">        verbose: If True, print verbose logging messages.</span>
<span class="sd">            Default is False.</span>
<span class="sd">        debug: If True, print debug logging messages.</span>
<span class="sd">            Default is False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Version info with version string, download URL, and</span>
<span class="sd">            source name.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If required config fields are missing, invalid, or if</span>
<span class="sd">            JSONPath expressions don&#39;t match anything in the response.</span>
<span class="sd">        RuntimeError: If API call fails (chained with &#39;from err&#39;).</span>

<span class="sd">    Example:</span>
<span class="sd">        Get version info from JSON API:</span>

<span class="sd">            strategy = ApiJsonStrategy()</span>
<span class="sd">            config = {</span>
<span class="sd">                &quot;source&quot;: {</span>
<span class="sd">                    &quot;api_url&quot;: &quot;https://api.vendor.com/latest&quot;,</span>
<span class="sd">                    &quot;version_path&quot;: &quot;version&quot;,</span>
<span class="sd">                    &quot;download_url_path&quot;: &quot;download_url&quot;</span>
<span class="sd">                }</span>
<span class="sd">            }</span>
<span class="sd">            version_info = strategy.get_version_info(config)</span>
<span class="sd">            # version_info.version returns: &#39;1.0.0&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">notapkgtool.cli</span><span class="w"> </span><span class="kn">import</span> <span class="n">print_verbose</span>

    <span class="c1"># Validate configuration</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">app_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">api_url</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;api_url&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">api_url</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;api_json strategy requires &#39;source.api_url&#39; in config&quot;</span><span class="p">)</span>

    <span class="n">version_path</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;version_path&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">version_path</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;api_json strategy requires &#39;source.version_path&#39; in config&quot;</span>
        <span class="p">)</span>

    <span class="n">download_url_path</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;download_url_path&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">download_url_path</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;api_json strategy requires &#39;source.download_url_path&#39; in config&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Optional configuration</span>
    <span class="n">method</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;method&quot;</span><span class="p">,</span> <span class="s2">&quot;GET&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid method: </span><span class="si">{</span><span class="n">method</span><span class="si">!r}</span><span class="s2">. Must be &#39;GET&#39; or &#39;POST&#39;&quot;</span><span class="p">)</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;headers&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">timeout</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timeout&quot;</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>

    <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="s2">&quot;Strategy: api_json (version-first)&quot;</span><span class="p">)</span>
    <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;API URL: </span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Method: </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Version path: </span><span class="si">{</span><span class="n">version_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Download URL path: </span><span class="si">{</span><span class="n">download_url_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Expand environment variables in headers</span>
    <span class="n">expanded_headers</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">headers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;${&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;}&quot;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">env_var</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">env_value</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">env_var</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">env_value</span><span class="p">:</span>
                <span class="n">print_verbose</span><span class="p">(</span>
                    <span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;Warning: Environment variable </span><span class="si">{</span><span class="n">env_var</span><span class="si">}</span><span class="s2"> not set&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">expanded_headers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">env_value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">expanded_headers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="c1"># Make API request</span>
    <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Calling API: </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">api_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">expanded_headers</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># POST</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="n">api_url</span><span class="p">,</span>
                <span class="n">headers</span><span class="o">=</span><span class="n">expanded_headers</span><span class="p">,</span>
                <span class="n">json</span><span class="o">=</span><span class="n">body</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;API request failed: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to call API: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>

    <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;API response: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> OK&quot;</span><span class="p">)</span>

    <span class="c1"># Parse JSON response</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">json_data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Invalid JSON response from API. Response: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>

    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="n">print_verbose</span><span class="p">(</span>
            <span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;JSON response: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">json_data</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Extract version using JSONPath</span>
    <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Extracting version from path: </span><span class="si">{</span><span class="n">version_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">version_expr</span> <span class="o">=</span> <span class="n">jsonpath_parse</span><span class="p">(</span><span class="n">version_path</span><span class="p">)</span>
        <span class="n">version_matches</span> <span class="o">=</span> <span class="n">version_expr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">json_data</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">version_matches</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Version path </span><span class="si">{</span><span class="n">version_path</span><span class="si">!r}</span><span class="s2"> did not match anything in API response&quot;</span>
            <span class="p">)</span>

        <span class="n">version_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">version_matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="k">raise</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Failed to extract version using path </span><span class="si">{</span><span class="n">version_path</span><span class="si">!r}</span><span class="s2">: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>

    <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Extracted version: </span><span class="si">{</span><span class="n">version_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Extract download URL using JSONPath</span>
    <span class="n">print_verbose</span><span class="p">(</span>
        <span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Extracting download URL from path: </span><span class="si">{</span><span class="n">download_url_path</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">url_expr</span> <span class="o">=</span> <span class="n">jsonpath_parse</span><span class="p">(</span><span class="n">download_url_path</span><span class="p">)</span>
        <span class="n">url_matches</span> <span class="o">=</span> <span class="n">url_expr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">json_data</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">url_matches</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Download URL path </span><span class="si">{</span><span class="n">download_url_path</span><span class="si">!r}</span><span class="s2"> did not match anything in API response&quot;</span>
            <span class="p">)</span>

        <span class="n">download_url</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">url_matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="k">raise</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Failed to extract download URL using path </span><span class="si">{</span><span class="n">download_url_path</span><span class="si">!r}</span><span class="s2">: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>

    <span class="n">print_verbose</span><span class="p">(</span><span class="s2">&quot;DISCOVERY&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Download URL: </span><span class="si">{</span><span class="n">download_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">VersionInfo</span><span class="p">(</span>
        <span class="n">version</span><span class="o">=</span><span class="n">version_str</span><span class="p">,</span>
        <span class="n">download_url</span><span class="o">=</span><span class="n">download_url</span><span class="p">,</span>
        <span class="n">source</span><span class="o">=</span><span class="s2">&quot;api_json&quot;</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="notapkgtool.discovery.api_json.ApiJsonStrategy.validate_config" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <span class="doc doc-object-name doc-function-name">validate_config</span>


</h4>
<div class="doc-signature highlight"><pre><span></span><code><span class="nf">validate_config</span><span class="p">(</span><span class="n">app_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Validate api_json strategy configuration.</p>
<p>Checks for required fields and correct types without making network calls.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>app_config</code>
            </td>
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The app configuration from the recipe.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of error messages (empty if valid).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>notapkgtool/discovery/api_json.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">validate_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate api_json strategy configuration.</span>

<span class="sd">    Checks for required fields and correct types without making network calls.</span>

<span class="sd">    Args:</span>
<span class="sd">        app_config: The app configuration from the recipe.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of error messages (empty if valid).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">app_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="p">{})</span>

    <span class="c1"># Check required fields</span>
    <span class="k">if</span> <span class="s2">&quot;api_url&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Missing required field: source.api_url&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;api_url&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.api_url must be a string&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;api_url&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.api_url cannot be empty&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;version_path&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Missing required field: source.version_path&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;version_path&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.version_path must be a string&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;version_path&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.version_path cannot be empty&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Validate JSONPath syntax</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">jsonpath_ng</span><span class="w"> </span><span class="kn">import</span> <span class="n">parse</span> <span class="k">as</span> <span class="n">jsonpath_parse</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">jsonpath_parse</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;version_path&quot;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid version_path JSONPath: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;download_url_path&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Missing required field: source.download_url_path&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;download_url_path&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.download_url_path must be a string&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;download_url_path&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.download_url_path cannot be empty&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Validate JSONPath syntax</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">jsonpath_ng</span><span class="w"> </span><span class="kn">import</span> <span class="n">parse</span> <span class="k">as</span> <span class="n">jsonpath_parse</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">jsonpath_parse</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;download_url_path&quot;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid download_url_path JSONPath: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Optional fields validation</span>
    <span class="k">if</span> <span class="s2">&quot;method&quot;</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">source</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.method must be a string&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">]:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.method must be &#39;GET&#39; or &#39;POST&#39;&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;headers&quot;</span> <span class="ow">in</span> <span class="n">source</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;headers&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.headers must be a dictionary&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;body&quot;</span> <span class="ow">in</span> <span class="n">source</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;body&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;source.body must be a dictionary&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">errors</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.tabs", "navigation.tabs.sticky"], "search": "../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
    
  </body>
</html>